<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NexusHub タイマー</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2064%2064%22%3E%0A%20%20%3Ccircle%20fill%3D%22%23FFFFFF%22%20cx%3D%2232%22%20cy%3D%2232%22%20r%3D%2232%22/%3E%0A%20%20%3Cpath%20fill%3D%22%234285F4%22%20d%3D%22M32%2011c6.5%200%2011.4%202.3%2015%205.8l5.8-5.8C46.6%206.3%2040%204%2032%204%2018.7%204%207.5%2014.5%207.5%2028S18.7%2052%2032%2052c11.6%200%2021.1-7.5%2023.5-18.1H32v-8.6h22.9c.2%201.1.4%202.4.4%203.7%200%2015.3-10.3%2026.5-23.3%2026.5-13.4%200-24.3-10.9-24.3-24.5S18.6%2011%2032%2011z%22/%3E%0A%20%20%3Cpath%20fill%3D%22%2334A853%22%20d%3D%22M32%2060c10.9%200%2020.1-3.6%2026.5-10.4l-7.8-7.6c-4.6%203.3-10.3%205.2-16.9%205.2-12.9%200-23.8-8.8-27.5-20.7H6.8v8.6C11.1%2048.9%2020.6%2060%2032%2060z%22/%3E%0A%20%20%3Cpath%20fill%3D%22%23FBBC05%22%20d%3D%22M11.3%2026.5c-.7-2-.9-4.1-.9-6.3s.3-4.3.9-6.3V5.3H6.8C3%2011.5%201%2018.6%201%2025.7s2%2014.2%205.8%2020.4l8.5-6.6c-2-4.2-3-8.7-3-13z%22/%3E%0A%20%20%3Cpath%20fill%3D%22%23EA4335%22%20d%3D%22M32%2012.3c4.6%200%208.4%201.5%2011.4%204.3l8.1-8C47.9%203.5%2040.7%201%2032%201%2020.6%201%2011.1%207.1%206.8%2016.9l8.5%206.3C18.9%2016%2024.7%2012.3%2032%2012.3z%22/%3E%0A%3C/svg%3E">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      color-scheme: light;
      --md-primary: #5E44FF;
      --md-on-primary: #FFFFFF;
      --md-surface: #FDFCFF;
      --md-surface-elevated: rgba(255, 255, 255, 0.82);
      --md-surface-container: #F1EBFF;
      --md-surface-container-high: #EAE3FF;
      --md-outline: #A09AB5;
      --md-outline-strong: #5B5673;
      --md-on-surface: #1C1B1F;
      --md-on-surface-variant: #4A4458;
      --md-shadow: rgba(28, 27, 31, 0.14);
      --md-success: #2E7D32;
      --md-error: #BA1A1A;
    }

    body[data-theme="dark"] {
      color-scheme: dark;
      --md-primary: #B9A5FF;
      --md-on-primary: #21005D;
      --md-surface: #141218;
      --md-surface-elevated: rgba(31, 28, 38, 0.78);
      --md-surface-container: #211F26;
      --md-surface-container-high: #2B2932;
      --md-outline: #524B63;
      --md-outline-strong: #A59BBE;
      --md-on-surface: #E8DEF8;
      --md-on-surface-variant: #C8C1D7;
      --md-shadow: rgba(0, 0, 0, 0.45);
      --md-success: #81C995;
      --md-error: #F2B8B5;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: linear-gradient(135deg, rgba(106, 76, 255, 0.18) 0%, rgba(253, 252, 255, 0) 45%),
                  radial-gradient(circle at 85% 12%, rgba(255, 182, 239, 0.22), transparent 48%),
                  var(--md-surface);
      color: var(--md-on-surface);
      margin: 0;
      padding: 40px 24px;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    body[data-theme="dark"] {
      background: linear-gradient(145deg, rgba(94, 68, 255, 0.24) 0%, rgba(20, 18, 24, 0.9) 55%),
                  radial-gradient(circle at 18% 12%, rgba(143, 76, 230, 0.24), transparent 42%),
                  var(--md-surface);
    }

    .timer-surface {
      background: var(--md-surface-elevated);
      border: 1px solid rgba(160, 154, 181, 0.35);
      border-radius: 32px;
      padding: 32px;
      width: min(460px, 100%);
      box-shadow: 0 28px 60px var(--md-shadow);
      display: flex;
      flex-direction: column;
      gap: 24px;
      backdrop-filter: blur(24px);
    }

    .timer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .timer-header h1 {
      font-size: 22px;
      font-weight: 700;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: 0.02em;
      color: var(--md-on-surface);
    }

    .timer-header h1 .material-icons {
      font-size: 26px;
      color: var(--md-primary);
    }

    .time-display {
      font-size: 56px;
      font-weight: 800;
      letter-spacing: 6px;
      text-align: center;
      background: linear-gradient(135deg, rgba(94, 68, 255, 1), rgba(143, 76, 230, 0.85));
      -webkit-background-clip: text;
      color: transparent;
    }

    .time-display.small {
      font-size: 38px;
    }

    .inputs-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    label {
      font-size: 12px;
      color: var(--md-on-surface-variant);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    input[type="number"] {
      appearance: textfield;
      border-radius: 16px;
      border: 1px solid rgba(160, 154, 181, 0.55);
      padding: 12px;
      font-size: 16px;
      background: rgba(255, 255, 255, 0.72);
      color: var(--md-on-surface);
      text-align: center;
      transition: transform 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease;
      box-shadow: inset 0 2px 6px rgba(28, 27, 31, 0.06);
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type="number"]:focus {
      outline: none;
      border-color: var(--md-primary);
      box-shadow: 0 0 0 4px rgba(94, 68, 255, 0.2);
      transform: translateY(-2px);
    }

    .quick-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 10px;
    }

    .chip-btn {
      border: 1px solid rgba(160, 154, 181, 0.4);
      border-radius: 999px;
      padding: 10px 16px;
      background: rgba(94, 68, 255, 0.08);
      color: var(--md-on-surface);
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.25s ease, background 0.25s ease, border 0.25s ease;
      backdrop-filter: blur(14px);
    }

    .chip-btn:hover {
      background: rgba(94, 68, 255, 0.18);
      border-color: rgba(94, 68, 255, 0.45);
      transform: translateY(-2px);
    }

    .controls {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .md-button {
      border: none;
      border-radius: 999px;
      padding: 14px 28px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.28s ease, box-shadow 0.28s ease, filter 0.28s ease;
    }

    .md-button.primary {
      background: linear-gradient(135deg, rgba(94, 68, 255, 1), rgba(116, 93, 255, 0.85));
      color: var(--md-on-primary);
      box-shadow: 0 18px 40px rgba(94, 68, 255, 0.4);
    }

    .md-button.secondary {
      background: rgba(255, 255, 255, 0.78);
      color: var(--md-on-surface);
      border: 1px solid rgba(160, 154, 181, 0.4);
      box-shadow: 0 12px 30px rgba(28, 27, 31, 0.12);
    }

    .md-button.destructive {
      background: linear-gradient(135deg, #FF5F74, #FF2D55);
      color: var(--md-on-primary);
      box-shadow: 0 18px 40px rgba(255, 45, 85, 0.35);
    }

    .md-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
      filter: saturate(0.6);
    }

    .md-button:not(:disabled):hover {
      transform: translateY(-3px);
    }

    body[data-theme="dark"] input[type="number"] {
      background: rgba(31, 28, 38, 0.78);
      border: 1px solid rgba(165, 155, 190, 0.45);
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.45);
    }

    body[data-theme="dark"] .chip-btn {
      background: rgba(185, 165, 255, 0.16);
      border-color: rgba(165, 155, 190, 0.45);
    }

    body[data-theme="dark"] .chip-btn:hover {
      background: rgba(185, 165, 255, 0.26);
    }

    body[data-theme="dark"] .md-button.secondary {
      background: rgba(31, 28, 38, 0.82);
      color: var(--md-on-surface);
    }

    @media (max-width: 480px) {
      .timer-surface {
        padding: 26px 20px;
        gap: 20px;
      }

      .time-display {
        font-size: 44px;
        letter-spacing: 4px;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        transition-duration: 0.01ms !important;
        animation-duration: 0.01ms !important;
      }
    }

    .status-text {
      text-align: center;
      font-size: 13px;
      color: var(--md-on-surface-variant);
      min-height: 18px;
      letter-spacing: 0.02em;
    }

    .progress-track {
      position: relative;
      height: 6px;
      border-radius: 999px;
      background: rgba(94, 68, 255, 0.18);
      overflow: hidden;
    }

    .progress-bar {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 0;
      background: var(--md-primary);
      border-radius: 999px;
      transition: width 0.2s linear;
    }

    body[data-theme="dark"] .progress-track {
      background: rgba(185, 165, 255, 0.25);
    }

    @media (max-width: 420px) {
      .timer-surface {
        border-radius: 20px;
        padding: 20px;
      }

      .time-display {
        font-size: 40px;
      }

      .inputs-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }
  </style>
</head>
<body data-theme="light">
  <main class="timer-surface">
    <div class="timer-header">
      <h1><span class="material-icons">timer</span>カスタムタイマー</h1>
      <button class="chip-btn" id="notifyToggle" type="button">通知を有効化</button>
    </div>

    <div class="time-display" id="timeDisplay">00:00:00</div>
    <div class="progress-track"><div class="progress-bar" id="progressBar"></div></div>

    <form id="timerForm">
      <div class="inputs-grid">
        <label>時間
          <input type="number" id="hoursInput" min="0" max="23" value="0">
        </label>
        <label>分
          <input type="number" id="minutesInput" min="0" max="59" value="5">
        </label>
        <label>秒
          <input type="number" id="secondsInput" min="0" max="59" value="0">
        </label>
      </div>
    </form>

    <div class="quick-buttons">
      <button class="chip-btn" data-minutes="1" type="button">1分</button>
      <button class="chip-btn" data-minutes="5" type="button">5分</button>
      <button class="chip-btn" data-minutes="10" type="button">10分</button>
      <button class="chip-btn" data-minutes="15" type="button">15分</button>
      <button class="chip-btn" data-minutes="30" type="button">30分</button>
      <button class="chip-btn" data-minutes="45" type="button">45分</button>
    </div>

    <div class="controls">
      <button class="md-button primary" id="startBtn" type="button">
        <span class="material-icons">play_arrow</span>開始
      </button>
      <button class="md-button secondary" id="pauseBtn" type="button" disabled>
        <span class="material-icons">pause</span>一時停止
      </button>
      <button class="md-button secondary" id="resumeBtn" type="button" disabled>
        <span class="material-icons">play_circle</span>再開
      </button>
      <button class="md-button destructive" id="resetBtn" type="button" disabled>
        <span class="material-icons">restart_alt</span>リセット
      </button>
    </div>

    <div class="status-text" id="statusText">タイマーの長さを設定してください。</div>
  </main>

  <script>
    const hoursInput = document.getElementById('hoursInput');
    const minutesInput = document.getElementById('minutesInput');
    const secondsInput = document.getElementById('secondsInput');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resumeBtn = document.getElementById('resumeBtn');
    const resetBtn = document.getElementById('resetBtn');
    const statusText = document.getElementById('statusText');
    const timeDisplay = document.getElementById('timeDisplay');
    const progressBar = document.getElementById('progressBar');
    const notifyToggle = document.getElementById('notifyToggle');

    const THEME_STORAGE_KEY = 'nexushub-theme';
    const themePreferenceQuery = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;

    function applyPreferredTheme(theme) {
      const normalized = theme === 'dark' ? 'dark' : 'light';
      document.body.setAttribute('data-theme', normalized);
    }

    function handleIncomingTheme(theme) {
      const normalized = theme === 'dark' ? 'dark' : 'light';
      applyPreferredTheme(normalized);
      try {
        localStorage.setItem(THEME_STORAGE_KEY, normalized);
      } catch (error) {
        console.warn('テーマ設定の保存に失敗しました:', error);
      }
    }

    function resolveTimerTheme() {
      try {
        const stored = localStorage.getItem(THEME_STORAGE_KEY);
        if (stored === 'dark' || stored === 'light') {
          return stored;
        }
      } catch (error) {
        console.warn('テーマ設定の読み込みに失敗しました:', error);
      }
      if (themePreferenceQuery && typeof themePreferenceQuery.matches === 'boolean') {
        return themePreferenceQuery.matches ? 'dark' : 'light';
      }
      return 'light';
    }

    function syncThemeFromPreference() {
      applyPreferredTheme(resolveTimerTheme());
    }

    syncThemeFromPreference();

    window.addEventListener('focus', syncThemeFromPreference);
    window.addEventListener('storage', function(event) {
      if (event.key === THEME_STORAGE_KEY) {
        syncThemeFromPreference();
      }
    });

    window.addEventListener('message', function(event) {
      if (!event || typeof event.data !== 'object' || event.data === null) {
        return;
      }

      const data = event.data;
      if (data.type === 'nexushub-theme') {
        handleIncomingTheme(data.theme);
      }
    });

    if (themePreferenceQuery) {
      const handleThemeChange = function() {
        const stored = (() => {
          try {
            return localStorage.getItem(THEME_STORAGE_KEY);
          } catch (err) {
            return null;
          }
        })();
        if (!stored) {
          syncThemeFromPreference();
        }
      };

      if (typeof themePreferenceQuery.addEventListener === 'function') {
        themePreferenceQuery.addEventListener('change', handleThemeChange);
      } else if (typeof themePreferenceQuery.addListener === 'function') {
        themePreferenceQuery.addListener(handleThemeChange);
      }
    }

    let countdownInterval = null;
    let remainingMs = 0;
    let totalMs = 0;
    let isRunning = false;
    const alarmAudio = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');
    alarmAudio.preload = 'auto';

    function pad(value) {
      return String(value).padStart(2, '0');
    }

    function updateDisplay(ms) {
      const totalSeconds = Math.max(0, Math.floor(ms / 1000));
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      const formatted = pad(hours) + ':' + pad(minutes) + ':' + pad(seconds);
      timeDisplay.textContent = formatted;
      timeDisplay.classList.toggle('small', hours > 0);

      if (totalMs > 0) {
        const progress = 100 - Math.floor((ms / totalMs) * 100);
        progressBar.style.width = Math.min(100, Math.max(0, progress)) + '%';
      } else {
        progressBar.style.width = '0%';
      }
    }

    function parseInputs() {
      const hours = Number(hoursInput.value) || 0;
      const minutes = Number(minutesInput.value) || 0;
      const seconds = Number(secondsInput.value) || 0;
      return ((hours * 3600) + (minutes * 60) + seconds) * 1000;
    }

    function setStatus(message, tone = 'neutral') {
      statusText.textContent = message;
      if (tone === 'error') {
        statusText.style.color = 'var(--md-error)';
      } else if (tone === 'success') {
        statusText.style.color = 'var(--md-success)';
      } else {
        statusText.style.color = 'var(--md-on-surface-variant)';
      }
    }

    function startTimer() {
      if (isRunning) {
        return;
      }

      const duration = parseInputs();
      if (!duration || duration <= 0) {
        setStatus('1秒以上の時間を設定してください。', 'error');
        return;
      }

      totalMs = duration;
      remainingMs = duration;
      updateDisplay(remainingMs);
      runTimer();
      setStatus('タイマーを開始しました。', 'success');
      startBtn.disabled = true;
      pauseBtn.disabled = false;
      resetBtn.disabled = false;
      resumeBtn.disabled = true;
    }

    function runTimer() {
      if (countdownInterval) {
        clearInterval(countdownInterval);
      }

      isRunning = true;
      countdownInterval = setInterval(() => {
        remainingMs -= 1000;
        updateDisplay(remainingMs);

        if (remainingMs <= 0) {
          clearInterval(countdownInterval);
          countdownInterval = null;
          isRunning = false;
          progressBar.style.width = '100%';
          handleTimerComplete();
        }
      }, 1000);
    }

    function pauseTimer() {
      if (!isRunning) {
        return;
      }

      isRunning = false;
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      setStatus('一時停止中です。');
      pauseBtn.disabled = true;
      resumeBtn.disabled = remainingMs <= 0;
      startBtn.disabled = true;
    }

    function resumeTimer() {
      if (isRunning || remainingMs <= 0) {
        return;
      }

      runTimer();
      setStatus('タイマーを再開しました。', 'success');
      pauseBtn.disabled = false;
      resumeBtn.disabled = true;
    }

    function resetTimer() {
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      isRunning = false;
      remainingMs = 0;
      totalMs = parseInputs();
      updateDisplay(totalMs || 0);
      setStatus('タイマーをリセットしました。');
      startBtn.disabled = false;
      pauseBtn.disabled = true;
      resumeBtn.disabled = true;
      resetBtn.disabled = true;
      progressBar.style.width = '0%';
    }

    function handleTimerComplete() {
      setStatus('時間になりました！', 'success');
      startBtn.disabled = false;
      pauseBtn.disabled = true;
      resumeBtn.disabled = true;
      resetBtn.disabled = false;

      alarmAudio.currentTime = 0;
      alarmAudio.play().catch(() => {});

      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('タイマー', {
          body: '設定した時間が経過しました。',
          icon: 'https://www.gstatic.com/images/branding/product/2x/googleg_48dp.png'
        });
      } else {
        alert('時間になりました！');
      }
    }

    function handleQuickButton(event) {
      const minutes = Number(event.currentTarget.getAttribute('data-minutes')) || 0;
      hoursInput.value = Math.floor(minutes / 60);
      minutesInput.value = minutes % 60;
      secondsInput.value = 0;
      resetTimer();
      setStatus(minutes + '分のタイマーをセットしました。');
    }

    function requestNotificationPermission() {
      if (!('Notification' in window)) {
        setStatus('ブラウザが通知に対応していません。', 'error');
        return;
      }

      if (Notification.permission === 'granted') {
        setStatus('通知は既に有効です。', 'success');
        notifyToggle.textContent = '通知が有効です';
        notifyToggle.disabled = true;
        return;
      }

      Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
          setStatus('通知を有効化しました。', 'success');
          notifyToggle.textContent = '通知が有効です';
          notifyToggle.disabled = true;
        } else {
          setStatus('通知が許可されませんでした。', 'error');
        }
      });
    }

    document.querySelectorAll('.chip-btn[data-minutes]').forEach(button => {
      button.addEventListener('click', handleQuickButton);
    });

    startBtn.addEventListener('click', startTimer);
    pauseBtn.addEventListener('click', pauseTimer);
    resumeBtn.addEventListener('click', resumeTimer);
    resetBtn.addEventListener('click', resetTimer);
    notifyToggle.addEventListener('click', requestNotificationPermission);

    hoursInput.addEventListener('change', () => {
      hoursInput.value = Math.min(Math.max(Number(hoursInput.value) || 0, 0), 23);
      if (!isRunning) {
        updateDisplay(parseInputs());
      }
    });

    minutesInput.addEventListener('change', () => {
      minutesInput.value = Math.min(Math.max(Number(minutesInput.value) || 0, 0), 59);
      if (!isRunning) {
        updateDisplay(parseInputs());
      }
    });

    secondsInput.addEventListener('change', () => {
      secondsInput.value = Math.min(Math.max(Number(secondsInput.value) || 0, 0), 59);
      if (!isRunning) {
        updateDisplay(parseInputs());
      }
    });

    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && !isRunning && remainingMs > 0 && remainingMs < totalMs) {
        setStatus('再開するには再開ボタンを押してください。');
      }
    });

    updateDisplay(parseInputs());

    if ('Notification' in window && Notification.permission === 'granted') {
      notifyToggle.textContent = '通知が有効です';
      notifyToggle.disabled = true;
    }

    function announceTimerReady() {
      const message = { type: 'nexushub-timer-ready' };
      try {
        if (window.parent && window.parent !== window) {
          window.parent.postMessage(message, '*');
        }
      } catch (error) {
        console.warn('親フレームへの通知に失敗しました:', error);
      }

      try {
        if (window.opener && !window.opener.closed) {
          window.opener.postMessage(message, '*');
        }
      } catch (error) {
        console.warn('オープナーへの通知に失敗しました:', error);
      }
    }

    announceTimerReady();
  </script>
</body>
</html>
