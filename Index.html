<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NexusHub - 統合ワークスペースポータル</title>
  <link rel="icon" type="image/png" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNTYgMjYyIj4KICA8cmVjdCBmaWxsPSIjZmZmZmZmIiB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI2MiIgcng9IjY0Ii8+CiAgPHBhdGggZmlsbD0iIzQyODVGNCIgZD0iTTI1NS44NiAxMzMuNWMwLTguOS0uNzgtMTcuNi0yLjI1LTI2SDEzMHY0OS4yaDcwLjVjLTMgMTYtMTIuMSAyOS41LTI1LjkgMzguNnYzMi4yaDQxLjljMjQuNS0yMi41IDM4LjQtNTUuOSAzOC40LTk0eiIvPgogIDxwYXRoIGZpbGw9IiMzNEE4NTMiIGQ9Ik0xMzAgMjYwYzM1IDAgNjQuNC0xMS42IDg1LjktMzEuNWwtNDEuOS0zMi4yYy0xMS43IDcuOS0yNi42IDEyLjUtNDQgMTIuNS0zMy44IDAtNjIuNS0yMi44LTcyLjgtNTMuNkgxMy40djMzLjZDMzQuNyAyMzAgNzguMiAyNjAgMTMwIDI2MHoiLz4KICA8cGF0aCBmaWxsPSIjRkJCQzA1IiBkPSJNNTcuMiAxNTUuMmMtMi42LTcuOS00LTE2LjMtNC0yNS4yczEuNC0xNy4zIDQtMjUuMlY3MS4ySDEzLjRDNS41IDg2LjYgMSAxMDQuMyAxIDEyMi44czQuNSAzNi4yIDEyLjQgNTEuNmw0My44LTMzLjJ6Ii8+CiAgPHBhdGggZmlsbD0iI0VBNDMzNSIgZD0iTTEzMCA1MS42YzE4LjkgMCAzNS44IDYuNSA0OS4xIDE5LjRsMzYuNy0zNi43QzE5NC4zIDEyLjYgMTY1IDEgMTMwIDEgNzguMiAxIDM0LjcgMzEgMTMuNCA3MS4ybDQzLjggMzMuNmMxMC4zLTMwLjggMzktNTMuNiA3Mi44LTUzLjZ6Ii8+Cjwvc3ZnPg==">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      color-scheme: light;
      --sys-color-primary: #6750A4;
      --sys-color-on-primary: #FFFFFF;
      --sys-color-secondary: #625B71;
      --sys-color-tertiary: #7D5260;
      --sys-color-surface: #FDF8FF;
      --sys-color-surface-dim: #E9E0F1;
      --sys-color-surface-bright: #FFFBFF;
      --sys-color-surface-container-low: #F7EFFA;
      --sys-color-surface-container: #EFE6F3;
      --sys-color-surface-container-high: #E9E1EF;
      --sys-color-surface-container-highest: #E1D8E8;
      --sys-color-outline: #7A7289;
      --sys-color-outline-variant: #CCC2DC;
      --sys-color-on-surface: #1D1B20;
      --sys-color-on-surface-variant: #49454E;
      --sys-color-error: #B3261E;
      --sys-color-on-error: #FFFFFF;
      --sys-shadow: 0 24px 48px rgba(29, 27, 32, 0.08);
      --sys-shadow-sm: 0 12px 24px rgba(29, 27, 32, 0.06);
    }

    body[data-theme="dark"] {
      color-scheme: dark;
      --sys-color-primary: #D0BCFF;
      --sys-color-on-primary: #381E72;
      --sys-color-secondary: #CCC2DC;
      --sys-color-tertiary: #EFB8C8;
      --sys-color-surface: #141218;
      --sys-color-surface-dim: #141218;
      --sys-color-surface-bright: #3B3945;
      --sys-color-surface-container-low: #1F1B25;
      --sys-color-surface-container: #221F2A;
      --sys-color-surface-container-high: #2C2833;
      --sys-color-surface-container-highest: #36323D;
      --sys-color-outline: #938F99;
      --sys-color-outline-variant: #49454F;
      --sys-color-on-surface: #E6E0E9;
      --sys-color-on-surface-variant: #CAC4D0;
      --sys-color-error: #F2B8B5;
      --sys-color-on-error: #601410;
      --sys-shadow: 0 24px 48px rgba(0, 0, 0, 0.45);
      --sys-shadow-sm: 0 12px 24px rgba(0, 0, 0, 0.35);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: radial-gradient(circle at top right, rgba(103, 80, 164, 0.12), transparent 55%),
                  radial-gradient(circle at bottom left, rgba(98, 91, 113, 0.12), transparent 60%),
                  var(--sys-color-surface);
      color: var(--sys-color-on-surface);
      margin: 0;
      min-height: 100vh;
      padding: 32px clamp(16px, 3vw, 40px);
      transition: background 0.3s ease, color 0.3s ease;
    }

    .container {
      max-width: 1320px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    header {
      background: var(--sys-color-surface-container-high);
      border-radius: 28px;
      border: 1px solid var(--sys-color-outline-variant);
      box-shadow: var(--sys-shadow);
      padding: 24px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 32px;
      flex-wrap: wrap;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 28px;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 24px;
      font-weight: 700;
      color: var(--sys-color-on-surface);
      margin: 0;
    }

    .brand-logo {
      width: 48px;
      height: 48px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 16px;
      background: var(--sys-color-surface-container);
      box-shadow: var(--sys-shadow-sm);
    }

    .brand-logo svg {
      width: 36px;
      height: 36px;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-name {
      font-size: 22px;
      letter-spacing: 0.2px;
    }

    .brand-tagline {
      font-size: 12px;
      color: var(--sys-color-on-surface-variant);
      letter-spacing: 0.4px;
    }

    .nav-buttons {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .nav-btn {
      --accent: var(--sys-color-primary);
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 18px;
      border-radius: 999px;
      background: color-mix(in srgb, var(--accent) 16%, var(--sys-color-surface));
      border: 1px solid color-mix(in srgb, var(--accent) 38%, transparent);
      color: color-mix(in srgb, var(--accent) 80%, var(--sys-color-on-surface));
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(103, 80, 164, 0.16);
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .nav-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(103, 80, 164, 0.24);
      background: color-mix(in srgb, var(--accent) 28%, var(--sys-color-surface));
    }

    .nav-btn:focus-visible {
      outline: 3px solid color-mix(in srgb, var(--accent) 60%, transparent);
      outline-offset: 2px;
    }

    .nav-btn.gemini { --accent: #3C6EEF; }
    .nav-btn.gmail { --accent: #C5221F; }
    .nav-btn.chat { --accent: #0B8043; }
    .nav-btn.calendar { --accent: #1A73E8; }
    .nav-btn.drive { --accent: #137333; }
    .nav-btn.timer { --accent: var(--sys-color-primary); }

    .nav-icon {
      width: 22px;
      height: 22px;
      border-radius: 6px;
      object-fit: contain;
    }

    .badge {
      position: absolute;
      top: -6px;
      right: -6px;
      min-width: 22px;
      padding: 2px 6px;
      border-radius: 999px;
      background: var(--sys-color-error);
      color: var(--sys-color-on-error);
      font-size: 11px;
      font-weight: 700;
      box-shadow: 0 8px 18px rgba(179, 38, 30, 0.32);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 24px;
      flex-wrap: wrap;
    }

    .mode-toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 999px;
      border: 1px solid var(--sys-color-outline-variant);
      background: var(--sys-color-surface-container);
      color: var(--sys-color-on-surface);
      cursor: pointer;
      box-shadow: var(--sys-shadow-sm);
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .mode-toggle:hover {
      transform: translateY(-1px);
      background: var(--sys-color-surface-container-highest);
    }

    .mode-toggle .material-icons {
      font-size: 20px;
    }

    .mode-toggle-label {
      font-size: 13px;
      font-weight: 600;
    }

    .user-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
      text-align: right;
    }

    .user-email {
      font-weight: 700;
      color: var(--sys-color-on-surface);
      font-size: 14px;
    }

    .clock-section {
      display: flex;
      flex-direction: column;
      gap: 4px;
      border-left: 1px solid var(--sys-color-outline-variant);
      padding-left: 16px;
    }

    .clock {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.8px;
    }

    .date {
      font-size: 12px;
      color: var(--sys-color-on-surface-variant);
      letter-spacing: 0.4px;
    }

    .summary-dashboard {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    .summary-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px;
      background: var(--sys-color-surface-container);
      border-radius: 24px;
      border: 1px solid var(--sys-color-outline-variant);
      box-shadow: var(--sys-shadow-sm);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .summary-item.clickable {
      cursor: pointer;
    }

    .summary-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 32px rgba(103, 80, 164, 0.18);
    }

    .summary-icon {
      width: 56px;
      height: 56px;
      border-radius: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--sys-color-surface-container-highest);
      color: var(--sys-color-primary);
      font-size: 26px;
      box-shadow: inset 0 0 0 1px var(--sys-color-outline-variant);
    }

    .summary-icon.email { color: #C5221F; }
    .summary-icon.chat { color: #0B8043; }
    .summary-icon.calendar { color: #1A73E8; }

    .summary-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1.1px;
      color: var(--sys-color-on-surface-variant);
      font-weight: 600;
    }

    .summary-value {
      display: flex;
      align-items: baseline;
      gap: 6px;
      font-size: 24px;
      font-weight: 700;
      color: var(--sys-color-on-surface);
    }

    .summary-unit {
      font-size: 13px;
      color: var(--sys-color-on-surface-variant);
      font-weight: 600;
    }

    .summary-subtext,
    .summary-meta {
      font-size: 12px;
      color: var(--sys-color-on-surface-variant);
      margin-top: 4px;
    }

    .summary-meta span + span {
      margin-left: 12px;
    }

    .main-content {
      display: grid;
      grid-template-columns: minmax(0, 320px) minmax(0, 1fr) minmax(0, 320px);
      gap: 24px;
    }

    .info-card {
      background: var(--sys-color-surface-container-high);
      border-radius: 28px;
      border: 1px solid var(--sys-color-outline-variant);
      box-shadow: var(--sys-shadow);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      min-height: 0;
    }

    .info-card h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--sys-color-on-surface);
    }

    .info-card h2 .material-symbols-rounded,
    .info-card h2 .material-icons {
      font-size: 22px;
      color: var(--sys-color-primary);
    }

    .calendar-widget {
      display: flex;
      flex-direction: column;
      gap: 16px;
      min-height: 0;
    }

    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .calendar-nav {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .calendar-header button {
      width: 36px;
      height: 36px;
      border-radius: 18px;
      border: 1px solid var(--sys-color-outline-variant);
      background: var(--sys-color-surface-container);
      color: var(--sys-color-on-surface);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease;
    }

    .calendar-header button:hover {
      background: var(--sys-color-surface-container-highest);
    }

    .today-btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: var(--sys-color-primary);
      color: var(--sys-color-on-primary);
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(103, 80, 164, 0.25);
    }

    .today-btn:hover {
      filter: brightness(1.05);
    }

    .add-event-quick-btn {
      width: 36px;
      height: 36px;
      border-radius: 18px;
      border: none;
      background: #1A73E8;
      color: #FFFFFF;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 24px rgba(26, 115, 232, 0.28);
    }

    .calendar-month {
      font-weight: 700;
      font-size: 16px;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 6px;
    }

    .calendar-day-header {
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: var(--sys-color-on-surface-variant);
    }

    .calendar-day {
      aspect-ratio: 1 / 1;
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      color: var(--sys-color-on-surface);
      background: var(--sys-color-surface-container);
      border: 1px solid transparent;
      transition: background 0.2s ease, border 0.2s ease, transform 0.2s ease;
      position: relative;
    }

    .calendar-day:hover {
      transform: translateY(-2px);
      background: var(--sys-color-surface-container-highest);
      border-color: var(--sys-color-outline-variant);
    }

    .calendar-day.other-month {
      color: var(--sys-color-on-surface-variant);
      opacity: 0.6;
    }

    .calendar-day.today {
      background: var(--sys-color-primary);
      color: var(--sys-color-on-primary);
      border-color: var(--sys-color-primary);
      box-shadow: 0 12px 28px rgba(103, 80, 164, 0.35);
    }

    .calendar-day.has-events::after {
      content: '';
      position: absolute;
      bottom: 10px;
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--sys-color-secondary);
    }

    .calendar-day.today.has-events::after {
      background: var(--sys-color-on-primary);
    }

    .calendar-event-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 240px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .calendar-event-list::-webkit-scrollbar {
      width: 6px;
    }

    .calendar-event-list::-webkit-scrollbar-thumb {
      background: color-mix(in srgb, var(--sys-color-primary) 35%, transparent);
      border-radius: 999px;
    }

    .calendar-event {
      background: var(--sys-color-surface-container);
      border-radius: 18px;
      border: 1px solid var(--sys-color-outline-variant);
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .calendar-event:hover {
      transform: translateY(-2px);
      box-shadow: var(--sys-shadow-sm);
    }

    .calendar-event-title {
      font-weight: 600;
      font-size: 14px;
    }

    .calendar-event-meta {
      display: flex;
      gap: 8px;
      font-size: 12px;
      color: var(--sys-color-on-surface-variant);
      flex-wrap: wrap;
    }

    .calendar-empty {
      padding: 32px;
      text-align: center;
      color: var(--sys-color-on-surface-variant);
      background: var(--sys-color-surface-container);
      border-radius: 24px;
      border: 1px dashed var(--sys-color-outline-variant);
    }

    .calendar-cta {
      margin-top: auto;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      align-self: flex-start;
      padding: 10px 16px;
      border-radius: 999px;
      text-decoration: none;
      color: var(--sys-color-primary);
      font-weight: 600;
      background: color-mix(in srgb, var(--sys-color-primary) 12%, var(--sys-color-surface));
      border: 1px solid color-mix(in srgb, var(--sys-color-primary) 32%, transparent);
      transition: transform 0.2s ease;
    }

    .calendar-cta:hover {
      transform: translateY(-2px);
    }

    .workspace-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
    }

    .board-column {
      background: var(--sys-color-surface-container);
      border-radius: 24px;
      border: 1px solid var(--sys-color-outline-variant);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: var(--sys-shadow-sm);
    }

    .board-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .board-title {
      font-weight: 600;
      font-size: 15px;
    }

    .board-count {
      font-size: 12px;
      color: var(--sys-color-on-surface-variant);
      background: var(--sys-color-surface-container-highest);
      border-radius: 999px;
      padding: 4px 10px;
      font-weight: 600;
    }

    .board-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 320px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .board-item {
      border-radius: 18px;
      border: 1px solid var(--sys-color-outline-variant);
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: var(--sys-color-surface);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .board-item:hover {
      transform: translateY(-1px);
      box-shadow: var(--sys-shadow-sm);
    }

    .board-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .board-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      font-weight: 600;
    }

    .board-chip.primary {
      background: color-mix(in srgb, var(--sys-color-primary) 15%, transparent);
      color: var(--sys-color-primary);
    }

    .board-chip.secondary {
      background: color-mix(in srgb, var(--sys-color-secondary) 18%, transparent);
      color: var(--sys-color-secondary);
    }

    .board-chip.tertiary {
      background: color-mix(in srgb, var(--sys-color-tertiary) 18%, transparent);
      color: var(--sys-color-tertiary);
    }

    .board-item-title {
      font-weight: 600;
      font-size: 14px;
    }

    .board-item-meta,
    .board-item-footer {
      font-size: 12px;
      color: var(--sys-color-on-surface-variant);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .board-item-action {
      margin-left: auto;
    }

    .board-item-action button {
      border: none;
      background: transparent;
      color: var(--sys-color-primary);
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 8px;
      transition: background 0.2s ease;
    }

    .board-item-action button:hover {
      background: color-mix(in srgb, var(--sys-color-primary) 15%, transparent);
    }

    .board-progress {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .progress-label {
      font-size: 12px;
      color: var(--sys-color-on-surface-variant);
      display: flex;
      justify-content: space-between;
    }

    .progress-track {
      position: relative;
      height: 8px;
      border-radius: 999px;
      background: color-mix(in srgb, var(--sys-color-primary) 12%, transparent);
      overflow: hidden;
    }

    .progress-value {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      border-radius: 999px;
      background: var(--sys-color-primary);
    }

    #emailList {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #emailList::-webkit-scrollbar {
      width: 6px;
    }

    #emailList::-webkit-scrollbar-thumb {
      background: color-mix(in srgb, var(--sys-color-primary) 28%, transparent);
      border-radius: 999px;
    }

    .email-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .email-item {
      background: var(--sys-color-surface);
      border-radius: 20px;
      border: 1px solid var(--sys-color-outline-variant);
      padding: 16px 18px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .email-item:hover {
      transform: translateY(-2px);
      box-shadow: var(--sys-shadow-sm);
    }

    .email-item.unread {
      border-color: color-mix(in srgb, #C5221F 40%, transparent);
      box-shadow: 0 12px 30px rgba(197, 34, 31, 0.22);
    }

    .email-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .email-from {
      font-weight: 700;
      font-size: 14px;
    }

    .email-date {
      font-size: 12px;
      color: var(--sys-color-on-surface-variant);
    }

    .email-subject {
      font-weight: 600;
      font-size: 15px;
    }

    .email-snippet {
      font-size: 13px;
      color: var(--sys-color-on-surface-variant);
      line-height: 1.5;
    }

    .chat-card {
      position: relative;
    }

    .chat-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
      min-height: 0;
    }

    .chat-board {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .chat-section {
      background: var(--sys-color-surface);
      border-radius: 24px;
      border: 1px solid var(--sys-color-outline-variant);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: var(--sys-shadow-sm);
    }

    .chat-section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }

    .chat-metrics {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chat-pill {
      background: color-mix(in srgb, var(--sys-color-primary) 18%, transparent);
      color: var(--sys-color-primary);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 600;
    }

    .chat-column {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .chat-column h3 {
      font-size: 14px;
      font-weight: 600;
      margin: 0;
      color: var(--sys-color-on-surface);
    }

    .chat-column-empty {
      padding: 28px;
      text-align: center;
      color: var(--sys-color-on-surface-variant);
      border-radius: 20px;
      border: 1px dashed var(--sys-color-outline-variant);
      background: var(--sys-color-surface-container);
    }

    .chat-entry {
      background: var(--sys-color-surface-container);
      border-radius: 18px;
      border: 1px solid var(--sys-color-outline-variant);
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      text-decoration: none;
      color: inherit;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .chat-entry:hover {
      transform: translateY(-2px);
      box-shadow: var(--sys-shadow-sm);
    }

    .chat-entry-title {
      font-weight: 600;
      font-size: 14px;
    }

    .chat-entry-meta {
      font-size: 12px;
      color: var(--sys-color-on-surface-variant);
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }

    .chat-entry-preview {
      font-size: 13px;
      color: var(--sys-color-on-surface-variant);
      line-height: 1.5;
      margin: 0;
    }

    .chat-entry-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
      padding: 6px 12px;
      border-radius: 999px;
      background: color-mix(in srgb, var(--sys-color-primary) 18%, transparent);
      color: var(--sys-color-primary);
      font-size: 12px;
      font-weight: 600;
      text-decoration: none;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .chat-entry-link:hover {
      transform: translateY(-1px);
      background: color-mix(in srgb, var(--sys-color-primary) 28%, transparent);
    }

    .no-unread-message {
      padding: 32px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      text-align: center;
      color: var(--sys-color-on-surface-variant);
      background: var(--sys-color-surface-container);
      border-radius: 24px;
      border: 1px dashed var(--sys-color-outline-variant);
    }

    .highlight-card {
      animation: focus-card 1.2s ease;
    }

    @keyframes focus-card {
      0% { box-shadow: 0 0 0 0 rgba(103, 80, 164, 0.4); }
      100% { box-shadow: 0 0 0 18px rgba(103, 80, 164, 0); }
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(20, 18, 24, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 32px;
      z-index: 1000;
    }

    .modal-content {
      background: var(--sys-color-surface);
      border-radius: 28px;
      max-width: 720px;
      width: min(720px, 100%);
      max-height: min(620px, 100%);
      border: 1px solid var(--sys-color-outline-variant);
      box-shadow: 0 32px 64px rgba(0, 0, 0, 0.24);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .modal-header {
      padding: 18px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: var(--sys-color-surface-container);
      border-bottom: 1px solid var(--sys-color-outline-variant);
    }

    .modal-header h3 {
      margin: 0;
      font-size: 18px;
    }

    .close-btn,
    .popout-btn {
      border: none;
      background: transparent;
      color: var(--sys-color-on-surface);
      font-size: 18px;
      cursor: pointer;
      padding: 6px;
      border-radius: 12px;
      transition: background 0.2s ease;
    }

    .close-btn:hover,
    .popout-btn:hover {
      background: var(--sys-color-surface-container);
    }

    .modal-body {
      padding: 0;
      flex: 1;
      position: relative;
      display: flex;
      flex-direction: column;
      background: var(--sys-color-surface);
    }

    .timer-modal-body {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: stretch;
      min-height: 420px;
    }

    #timerIframe {
      flex: 1;
      border: none;
      border-bottom-left-radius: 28px;
      border-bottom-right-radius: 28px;
      background: var(--sys-color-surface);
    }

    #timerLoadingIndicator {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      background: radial-gradient(circle at center, rgba(103, 80, 164, 0.08), transparent 70%);
      color: var(--sys-color-on-surface);
      font-weight: 600;
      letter-spacing: 0.4px;
    }

    #timerLoadingIndicator[hidden] {
      display: none;
    }

    #timerLoadingIndicator .spinner {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 3px solid color-mix(in srgb, var(--sys-color-primary) 30%, transparent);
      border-top-color: var(--sys-color-primary);
      animation: spinner 0.8s linear infinite;
    }

    @keyframes spinner {
      to { transform: rotate(360deg); }
    }

    .loading-spinner {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: var(--sys-color-on-surface-variant);
      font-size: 14px;
    }

    footer {
      text-align: center;
      font-size: 12px;
      color: var(--sys-color-on-surface-variant);
      padding-bottom: 24px;
    }

    @media (max-width: 1200px) {
      .main-content {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 960px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }

      .main-content {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 24px 16px;
      }

      header {
        padding: 20px;
      }

      .nav-buttons {
        width: 100%;
      }

      .summary-dashboard {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body data-theme="light">
  <div class="container">
    <header>
      <div class="header-left">
        <h1 class="brand">
          <span class="brand-logo" aria-hidden="true">
            <svg viewBox="0 0 256 262" role="presentation" focusable="false">
              <path fill="#4285F4" d="M255.86 133.5c0-8.9-.78-17.6-2.25-26H130v49.2h70.5c-3 16-12.1 29.5-25.9 38.6v32.2h41.9c24.5-22.5 38.4-55.9 38.4-94z"/>
              <path fill="#34A853" d="M130 260c35 0 64.4-11.6 85.9-31.5l-41.9-32.2c-11.7 7.9-26.6 12.5-44 12.5-33.8 0-62.5-22.8-72.8-53.6H13.4v33.6C34.7 230 78.2 260 130 260z"/>
              <path fill="#FBBC05" d="M57.2 155.2c-2.6-7.9-4-16.3-4-25.2s1.4-17.3 4-25.2V71.2H13.4C5.5 86.6 1 104.3 1 122.8s4.5 36.2 12.4 51.6l43.8-33.2z"/>
              <path fill="#EA4335" d="M130 51.6c18.9 0 35.8 6.5 49.1 19.4l36.7-36.7C194.3 12.6 165 1 130 1 78.2 1 34.7 31 13.4 71.2l43.8 33.6c10.3-30.8 39-53.6 72.8-53.6z"/>
            </svg>
          </span>
          <span class="brand-text">
            <span class="brand-name">NexusHub</span>
            <span class="brand-tagline">Unified workspace intelligence</span>
          </span>
        </h1>
        <div class="nav-buttons">
          <a href="https://gemini.google.com" target="_blank" class="nav-btn gemini">
            <img class="nav-icon" src="https://www.gstatic.com/gemini/static/images/icons/gemini_color_96dp.svg" alt="Gemini" loading="lazy">
            Gemini
          </a>
          <a href="https://mail.google.com" target="_blank" class="nav-btn gmail" id="gmailBtn" aria-label="Gmail">
            <span class="badge" id="unreadBadge" style="display: none;">0</span>
            <img class="nav-icon" src="https://www.gstatic.com/images/branding/product/2x/gmail_48dp.png" alt="Gmail" loading="lazy">
            Gmail
          </a>
          <a href="https://chat.google.com" target="_blank" class="nav-btn chat" aria-label="Google Chat">
            <span class="badge" id="chatBadge" style="display: none;">0</span>
            <img class="nav-icon" src="https://www.gstatic.com/images/branding/product/2x/chat_2020q4_48dp.png" alt="Chat" loading="lazy">
            Chat
          </a>
          <a href="https://calendar.google.com" target="_blank" class="nav-btn calendar">
            <img class="nav-icon" src="https://www.gstatic.com/images/branding/product/2x/calendar_48dp.png" alt="Calendar" loading="lazy">
            Calendar
          </a>
          <a href="https://drive.google.com" target="_blank" class="nav-btn drive">
            <img class="nav-icon" src="https://www.gstatic.com/images/branding/product/2x/drive_2020q4_48dp.png" alt="Drive" loading="lazy">
            Drive
          </a>
          <button type="button" class="nav-btn timer" onclick="openTimerWindow()">
            <span class="material-symbols-rounded">timer</span>
            タイマー
          </button>
        </div>
      </div>
      <div class="header-right">
        <button type="button" class="mode-toggle" id="themeToggle" aria-label="テーマを切り替え">
          <span class="material-icons" id="themeToggleIcon">dark_mode</span>
          <span class="mode-toggle-label" id="themeToggleLabel">ダーク</span>
        </button>
        <div class="user-info">
          <div class="user-email" id="userEmail">読み込み中...</div>
        </div>
        <div class="clock-section">
          <div class="clock" id="clock">--:--:--</div>
          <div class="date" id="date">----年--月--日</div>
        </div>
      </div>
    </header>

    <div class="summary-dashboard">
      <div class="summary-item" id="gmailSummary">
        <div class="summary-icon email"><span class="material-symbols-rounded">mail</span></div>
        <div class="summary-content">
          <div class="summary-label">未読メール</div>
          <div class="summary-value" id="summaryUnreadCount">
            <span>0</span>
            <span class="summary-unit">件</span>
          </div>
          <div class="summary-subtext" id="summaryLatestEmail"></div>
        </div>
      </div>

      <div class="summary-item clickable" id="chatSummary" onclick="scrollToChat()">
        <div class="summary-icon chat"><span class="material-symbols-rounded">forum</span></div>
        <div class="summary-content">
          <div class="summary-label">未読チャット</div>
          <div class="summary-value" id="summaryChatCount">
            <span>0</span>
            <span class="summary-unit">件</span>
          </div>
          <div class="summary-subtext" id="summaryChatLatest"></div>
          <div class="summary-meta" id="summaryChatBreakdown"></div>
        </div>
      </div>

      <div class="summary-item clickable" id="todayEventSummary" onclick="showTodayEvents()">
        <div class="summary-icon event"><span class="material-symbols-rounded">event</span></div>
        <div class="summary-content">
          <div class="summary-label">本日の予定</div>
          <div class="summary-value" id="summaryEventCount">
            <span>0</span>
            <span class="summary-unit">件</span>
          </div>
        </div>
      </div>

      <div class="summary-item clickable" id="nextEventSummary" onclick="showNextEventDetail()">
        <div class="summary-icon next"><span class="material-symbols-rounded">schedule</span></div>
        <div class="summary-content">
          <div class="summary-label">次の予定</div>
          <div class="summary-value" id="summaryNextEvent">予定なし</div>
          <div class="summary-subtext" id="summaryNextEventTime"></div>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div class="content-column">
        <div class="info-card email-card">
          <h2><span class="material-icons">inbox</span>最新メール</h2>
          <div id="emailList">
            <div class="loading-spinner"><div class="spinner"></div><p>読み込み中...</p></div>
          </div>
        </div>

        <div class="info-card chat-card" id="chatCard">
          <h2><span class="material-icons">forum</span>未読チャット</h2>
          <div class="chat-board" id="chatList">
            <div class="chat-columns">
              <section class="chat-column" aria-labelledby="chatDmHeading">
                <div class="chat-column-header" id="chatDmHeading">
                  <span class="material-symbols-rounded">person</span>
                  <span>ダイレクトメッセージ</span>
                  <span class="count-chip" id="chatDmCount">0</span>
                </div>
                <div class="chat-stream" id="chatDmList">
                  <div class="loading-spinner"><div class="spinner"></div><p>読み込み中...</p></div>
                </div>
              </section>
              <section class="chat-column" aria-labelledby="chatSpaceHeading">
                <div class="chat-column-header" id="chatSpaceHeading">
                  <span class="material-symbols-rounded">groups</span>
                  <span>スペース</span>
                  <span class="count-chip" id="chatSpaceCount">0</span>
                </div>
                <div class="chat-stream" id="chatSpaceList">
                  <div class="loading-spinner"><div class="spinner"></div><p>読み込み中...</p></div>
                </div>
              </section>
            </div>
            <div class="chat-empty-state" id="chatEmptyState" style="display: none;">
              <span class="material-symbols-rounded">mark_chat_read</span>
              <p>最新の未読チャットはありません。</p>
              <button class="assist-btn" type="button" onclick="window.open('https://chat.google.com', '_blank')">
                <span class="material-symbols-rounded">open_in_new</span>Chatを開く
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="content-column">
        <div class="info-card">
          <div class="links-section">
            <div class="links-header">
              <div class="links-title"><span class="material-icons">bookmark</span>マイリンク</div>
              <div class="links-actions">
                <button class="add-folder-btn" onclick="openReorderModal()">
                  <span class="material-icons">swap_vert</span>並替
                </button>
                <button class="add-folder-btn" onclick="openFolderModal()">
                  <span class="material-icons">create_new_folder</span>フォルダ
                </button>
                <button class="add-link-btn" onclick="openLinkModal()">
                  <span class="material-icons">add</span>リンク
                </button>
              </div>
            </div>
            <div id="customLinksList">
              <div class="loading-spinner"><div class="spinner"></div><p>読み込み中...</p></div>
            </div>
          </div>
        </div>
      </div>

      <div class="content-column utility-column">
        <div class="info-card quick-actions-card">
          <h2><span class="material-icons">rocket_launch</span>ワークスペースクイックランチャー</h2>
          <p class="quick-actions-description">頻繁に使う Google Workspace アプリをワンクリックで起動できます。新規作成や会議の開始をスムーズに行いましょう。</p>
          <div class="quick-launch-grid" id="quickLaunchGrid">
            <button type="button" class="quick-launch-btn" data-url="https://docs.new" aria-label="Google ドキュメントを作成">
              <span class="quick-launch-icon" aria-hidden="true"><img src="https://www.gstatic.com/images/branding/product/1x/docs_2020q4_48dp.png" alt=""></span>
              <span class="quick-launch-label">
                <span class="quick-launch-title">ドキュメント</span>
                <span class="quick-launch-subtitle">空白のドキュメントを作成</span>
              </span>
            </button>
            <button type="button" class="quick-launch-btn" data-url="https://sheets.new" aria-label="Google スプレッドシートを作成">
              <span class="quick-launch-icon" aria-hidden="true"><img src="https://www.gstatic.com/images/branding/product/1x/sheets_2020q4_48dp.png" alt=""></span>
              <span class="quick-launch-label">
                <span class="quick-launch-title">スプレッドシート</span>
                <span class="quick-launch-subtitle">チームで使えるシートを開始</span>
              </span>
            </button>
            <button type="button" class="quick-launch-btn" data-url="https://slides.new" aria-label="Google スライドを作成">
              <span class="quick-launch-icon" aria-hidden="true"><img src="https://www.gstatic.com/images/branding/product/1x/slides_2020q4_48dp.png" alt=""></span>
              <span class="quick-launch-label">
                <span class="quick-launch-title">スライド</span>
                <span class="quick-launch-subtitle">プレゼン資料をすぐに準備</span>
              </span>
            </button>
            <button type="button" class="quick-launch-btn" data-url="https://meet.new" aria-label="Google Meet を開始">
              <span class="quick-launch-icon" aria-hidden="true"><img src="https://www.gstatic.com/images/branding/product/1x/meet_2020q4_48dp.png" alt=""></span>
              <span class="quick-launch-label">
                <span class="quick-launch-title">Meet</span>
                <span class="quick-launch-subtitle">ビデオ会議を今すぐ開始</span>
              </span>
            </button>
            <button type="button" class="quick-launch-btn" data-url="https://keep.google.com/" aria-label="Google Keep を開く">
              <span class="quick-launch-icon" aria-hidden="true"><img src="https://www.gstatic.com/images/branding/product/1x/keep_2020q4_48dp.png" alt=""></span>
              <span class="quick-launch-label">
                <span class="quick-launch-title">Keep</span>
                <span class="quick-launch-subtitle">アイデアやメモを整理</span>
              </span>
            </button>
          </div>
        </div>
        <div class="info-card calendar-card">
          <h2><span class="material-icons">event_note</span>カレンダー</h2>
          <div class="calendar-widget">
            <div class="calendar-header">
              <div class="calendar-nav">
                <button onclick="changeMonth(-1)"><span class="material-icons">chevron_left</span></button>
                <button class="today-btn" onclick="goToToday()">今日</button>
                <button onclick="changeMonth(1)"><span class="material-icons">chevron_right</span></button>
                <button class="add-event-quick-btn" onclick="openEventModal()" title="予定を追加">
                  <span class="material-icons">add</span>
                </button>
              </div>
              <div class="calendar-month" id="calendarMonth"></div>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
          </div>
        </div>

        <div class="info-card todo-card">
          <div class="todo-section">
            <div class="todo-header">
              <h2 style="margin-bottom: 0;"><span class="material-icons">check_circle</span>Todoリスト</h2>
              <button class="add-todo-btn" onclick="openTodoModal()">
                <span class="material-icons">add</span>追加
              </button>
            </div>
            <div id="todoList">
              <div class="loading-spinner"><div class="spinner"></div><p>読み込み中...</p></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <p>&copy; 2025 NexusHub - 統合ワークスペースポータル | Powered by T/G Policy</p>
    </footer>
  </div>

  <div id="timerModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="timerModalTitle">
    <div class="modal-content timer-modal-content">
      <div class="modal-header timer-modal-header">
        <h3 id="timerModalTitle">フォーカスタイマー</h3>
        <div class="modal-header-actions">
          <button type="button" class="popout-btn" id="timerPopoutButton">
            <span class="material-symbols-rounded" aria-hidden="true">open_in_new</span>
            別ウィンドウ
          </button>
          <button class="close-btn" type="button" onclick="closeModal('timerModal')" aria-label="閉じる">&times;</button>
        </div>
      </div>
      <div class="timer-modal-body">
        <div class="loading-spinner" id="timerLoadingIndicator">
          <div class="spinner"></div>
          <p>タイマーを準備中...</p>
        </div>
        <iframe id="timerIframe" title="NexusHub タイマー" loading="lazy" allow="autoplay" referrerpolicy="no-referrer"></iframe>
      </div>
    </div>
  </div>

  <!-- イベントモーダル -->
  <div id="eventModal" class="modal">
    <div class="modal-content large">
      <div class="modal-header">
        <h3 id="eventModalTitle">予定</h3>
        <button class="close-btn" onclick="closeModal('eventModal')">&times;</button>
      </div>
      <div id="eventModalBody"></div>
      <button class="add-event-from-modal-btn" onclick="openEventModalFromDate()" style="display: none;" id="addEventFromDateBtn">
        <span class="material-icons">add_circle</span>
        この日に予定を追加
      </button>
    </div>
  </div>

  <!-- イベント編集モーダル -->
  <div id="eventEditModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="eventEditModalTitle">予定を追加</h3>
        <button class="close-btn" onclick="closeModal('eventEditModal')">&times;</button>
      </div>
      <div>
        <div class="form-group">
          <label for="eventTitleInput">タイトル *</label>
          <input type="text" id="eventTitleInput" class="form-input" placeholder="予定のタイトル" />
        </div>
        <div class="form-checkbox-group">
          <input type="checkbox" id="eventAllDayCheckbox" class="form-checkbox" onchange="toggleAllDay()" />
          <label for="eventAllDayCheckbox" class="form-checkbox-label">終日</label>
        </div>
        <div class="form-row" id="eventDateTimeRow">
          <div class="form-group">
            <label for="eventStartInput">開始日時 *</label>
            <input type="datetime-local" id="eventStartInput" class="form-input" />
          </div>
          <div class="form-group">
            <label for="eventEndInput">終了日時 *</label>
            <input type="datetime-local" id="eventEndInput" class="form-input" />
          </div>
        </div>
        <div class="form-row" id="eventDateRow" style="display: none;">
          <div class="form-group">
            <label for="eventStartDateInput">開始日 *</label>
            <input type="date" id="eventStartDateInput" class="form-input" />
          </div>
          <div class="form-group">
            <label for="eventEndDateInput">終了日 *</label>
            <input type="date" id="eventEndDateInput" class="form-input" />
          </div>
        </div>
        <div class="form-group">
          <label for="eventLocationInput">場所</label>
          <input type="text" id="eventLocationInput" class="form-input" placeholder="場所" />
        </div>
        <div class="form-group">
          <label for="eventDescriptionInput">説明</label>
          <textarea id="eventDescriptionInput" class="form-textarea" placeholder="説明"></textarea>
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary" onclick="closeModal('eventEditModal')">キャンセル</button>
          <button class="btn btn-danger" id="deleteEventBtn" onclick="deleteEvent()" style="display: none;">
            <span class="material-icons" style="font-size: 18px;">delete</span>
            削除
          </button>
          <button class="btn btn-primary" onclick="saveEvent()">
            <span class="material-icons" style="font-size: 18px;">save</span>
            保存
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Todoモーダル -->
  <div id="todoModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="todoModalTitle">新規タスク</h3>
        <button class="close-btn" onclick="closeModal('todoModal')">&times;</button>
      </div>
      <div>
        <div class="form-group">
          <label for="todoTitleInput">タスク名 *</label>
          <input type="text" id="todoTitleInput" class="form-input" placeholder="タスク名を入力..." />
        </div>
        <div class="form-group">
          <label for="todoDueDateInput">期限</label>
          <input type="date" id="todoDueDateInput" class="form-input" />
        </div>
        <div class="form-group">
          <label for="todoNotesInput">メモ</label>
          <textarea id="todoNotesInput" class="form-textarea" placeholder="メモ（任意）"></textarea>
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary" onclick="closeModal('todoModal')">キャンセル</button>
          <button class="btn btn-primary" onclick="saveTodo()">
            <span class="material-icons" style="font-size: 18px;">save</span>
            保存
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- メールモーダル -->
  <div id="emailModal" class="modal">
    <div class="modal-content large">
      <div class="modal-header">
        <h3 id="emailModalTitle">メール</h3>
        <button class="close-btn" onclick="closeModal('emailModal')">&times;</button>
      </div>
      <div id="emailModalBody">
        <div class="loading-spinner">
          <div class="spinner"></div>
          <p>読み込み中...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- リンクモーダル -->
  <div id="linkModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="linkModalTitle">リンクを追加</h3>
        <button class="close-btn" onclick="closeModal('linkModal')">&times;</button>
      </div>
      <div>
        <div class="form-group">
          <label for="linkTitleInput">タイトル *</label>
          <input type="text" id="linkTitleInput" class="form-input" placeholder="例: 社内Wiki" />
        </div>
        <div class="form-group">
          <label for="linkUrlInput">URL *</label>
          <input type="url" id="linkUrlInput" class="form-input" placeholder="https://example.com" />
        </div>
        <div class="form-group">
          <label for="linkIconInput">アイコン</label>
          <select id="linkIconInput" class="form-select">
            <option value="code">GASアプリ</option>
            <option value="description">document</option>
            <option value="table_chart">spreadsheet</option>
            <option value="slideshow">slides</option>
            <option value="folder">GoogleDrive</option>
            <option value="language">Webサイト</option>
          </select>
        </div>
        <div class="form-group">
          <label for="linkFolderInput">フォルダ</label>
          <select id="linkFolderInput" class="form-select">
            <option value="">フォルダなし</option>
          </select>
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary" onclick="closeModal('linkModal')">キャンセル</button>
          <button class="btn btn-primary" onclick="saveLink()">
            <span class="material-icons" style="font-size: 18px;">save</span>
            保存
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- フォルダモーダル -->
  <div id="folderModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="folderModalTitle">フォルダを追加</h3>
        <button class="close-btn" onclick="closeModal('folderModal')">&times;</button>
      </div>
      <div>
        <div class="form-group">
          <label for="folderNameInput">フォルダ名 *</label>
          <input type="text" id="folderNameInput" class="form-input" placeholder="例: 仕事" />
        </div>
        <div class="form-group">
          <label for="folderParentInput">親フォルダ</label>
          <select id="folderParentInput" class="form-select">
            <option value="">なし（トップレベル）</option>
          </select>
        </div>
        <div class="form-group">
          <label>カラー</label>
          <div class="color-picker-group">
            <div class="color-option" style="background: #667eea;" data-color="#667eea" onclick="selectColor('#667eea')"></div>
            <div class="color-option" style="background: #43e97b;" data-color="#43e97b" onclick="selectColor('#43e97b')"></div>
            <div class="color-option" style="background: #F093FB;" data-color="#F093FB" onclick="selectColor('#F093FB')"></div>
            <div class="color-option" style="background: #4facfe;" data-color="#4facfe" onclick="selectColor('#4facfe')"></div>
            <div class="color-option" style="background: #F5576C;" data-color="#F5576C" onclick="selectColor('#F5576C')"></div>
            <div class="color-option" style="background: #fee140;" data-color="#fee140" onclick="selectColor('#fee140')"></div>
            <div class="color-option" style="background: #30cfd0;" data-color="#30cfd0" onclick="selectColor('#30cfd0')"></div>
            <div class="color-option" style="background: #8E54E9;" data-color="#8E54E9" onclick="selectColor('#8E54E9')"></div>
            <div class="color-option" style="background: #E74C3C;" data-color="#E74C3C" onclick="selectColor('#E74C3C')"></div>
            <div class="color-option" style="background: #F39C12;" data-color="#F39C12" onclick="selectColor('#F39C12')"></div>
            <div class="color-option" style="background: #27AE60;" data-color="#27AE60" onclick="selectColor('#27AE60')"></div>
            <div class="color-option" style="background: #2C3E50;" data-color="#2C3E50" onclick="selectColor('#2C3E50')"></div>
          </div>
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary" onclick="closeModal('folderModal')">キャンセル</button>
          <button class="btn btn-primary" onclick="saveFolder()">
            <span class="material-icons" style="font-size: 18px;">save</span>
            保存
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 並び替えモーダル -->
  <div id="reorderModal" class="modal reorder-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>並び替え</h3>
        <button class="close-btn" onclick="closeModal('reorderModal')">&times;</button>
      </div>
      <div id="reorderContent">
        <div class="loading-spinner">
          <div class="spinner"></div>
          <p>読み込み中...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth() + 1;
    let eventDatesData = {};
    let currentTaskLists = [];
    let editingTodoId = null;
    let editingTodoListId = null;
    let editingEventId = null;
    let currentEventDate = null;
    let emailRefreshInterval = null;
    let chatRefreshInterval = null;
    let calendarRefreshInterval = null;
    let summaryRefreshInterval = null;
    let currentThreadId = null;
    let editingLinkId = null;
    let editingFolderId = null;
    let selectedColor = '#667eea';
    let allFolders = [];
    let allLinks = [];
    let collapsedFolders = {};
    let todayEventsData = [];
    let nextEventData = null;
    let timerPopupRef = null;

    const timerModalElement = document.getElementById('timerModal');
    const timerIframeElement = document.getElementById('timerIframe');
    const timerLoadingIndicator = document.getElementById('timerLoadingIndicator');
    const timerPopoutButton = document.getElementById('timerPopoutButton');

    const THEME_STORAGE_KEY = 'nexushub-theme';
    const themeToggleButton = document.getElementById('themeToggle');
    const themeToggleIcon = document.getElementById('themeToggleIcon');
    const themeToggleLabel = document.getElementById('themeToggleLabel');
    const prefersDarkMediaQuery = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;

    function broadcastThemeToTimerSurfaces(theme) {
      if (!theme) return;

      if (timerIframeElement && timerIframeElement.contentWindow) {
        try {
          timerIframeElement.contentWindow.postMessage({ type: 'nexushub-theme', theme: theme }, '*');
        } catch (error) {
          console.warn('タイマーモーダルへのテーマ連携に失敗しました:', error);
        }
      }

      if (timerPopupRef && !timerPopupRef.closed) {
        try {
          timerPopupRef.postMessage({ type: 'nexushub-theme', theme: theme }, '*');
        } catch (error) {
          console.warn('タイマーポップアップへのテーマ連携に失敗しました:', error);
        }
      }
    }

    function syncThemeToggle(theme) {
      if (!themeToggleButton) return;
      if (theme === 'dark') {
        if (themeToggleIcon) themeToggleIcon.textContent = 'light_mode';
        if (themeToggleLabel) themeToggleLabel.textContent = 'ライト';
      } else {
        if (themeToggleIcon) themeToggleIcon.textContent = 'dark_mode';
        if (themeToggleLabel) themeToggleLabel.textContent = 'ダーク';
      }
    }

    function applyTheme(theme, options) {
      const root = document.body;
      if (!root) return;
      const normalized = theme === 'dark' ? 'dark' : 'light';
      root.setAttribute('data-theme', normalized);
      syncThemeToggle(normalized);
      broadcastThemeToTimerSurfaces(normalized);
      if (options && options.persist) {
        try {
          localStorage.setItem(THEME_STORAGE_KEY, normalized);
        } catch (err) {
          console.warn('テーマ設定を保存できませんでした:', err);
        }
      }
    }

    function getStoredTheme() {
      try {
        const stored = localStorage.getItem(THEME_STORAGE_KEY);
        if (stored === 'light' || stored === 'dark') {
          return stored;
        }
      } catch (err) {
        console.warn('テーマ設定の読み込みに失敗しました:', err);
      }
      return null;
    }

    function resolvePreferredTheme() {
      const stored = getStoredTheme();
      if (stored) {
        return stored;
      }
      if (prefersDarkMediaQuery && typeof prefersDarkMediaQuery.matches === 'boolean') {
        return prefersDarkMediaQuery.matches ? 'dark' : 'light';
      }
      return 'light';
    }

    function initializeTheme() {
      const initialTheme = resolvePreferredTheme();
      applyTheme(initialTheme);

      if (themeToggleButton) {
        themeToggleButton.addEventListener('click', function() {
          const currentTheme = document.body.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
          const nextTheme = currentTheme === 'dark' ? 'light' : 'dark';
          applyTheme(nextTheme, { persist: true });
        });
      }

      if (prefersDarkMediaQuery) {
        const handleMediaQueryChange = function(event) {
          const stored = getStoredTheme();
          if (stored) {
            syncThemeToggle(stored);
            return;
          }
          applyTheme(event.matches ? 'dark' : 'light');
        };

        if (typeof prefersDarkMediaQuery.addEventListener === 'function') {
          prefersDarkMediaQuery.addEventListener('change', handleMediaQueryChange);
        } else if (typeof prefersDarkMediaQuery.addListener === 'function') {
          prefersDarkMediaQuery.addListener(handleMediaQueryChange);
        }
      }

      window.addEventListener('storage', function(event) {
        if (event.key === THEME_STORAGE_KEY) {
          const nextTheme = event.newValue === 'dark' ? 'dark' : 'light';
          applyTheme(nextTheme);
        }
      });
    }

    initializeTheme();

    if (timerIframeElement) {
      timerIframeElement.addEventListener('load', function() {
        if (timerLoadingIndicator) {
          timerLoadingIndicator.setAttribute('hidden', 'true');
        }
      });
    }

    if (timerPopoutButton) {
      timerPopoutButton.addEventListener('click', function() {
        const popup = openTimerPopup(buildTimerUrl());
        if (!popup) {
          alert('ポップアップがブロックされています。ブラウザの設定を確認してください。');
        }
      });
    }

    window.addEventListener('message', function(event) {
      if (!event || typeof event.data !== 'object' || event.data === null) {
        return;
      }

      const data = event.data;
      if (data.type === 'nexushub-timer-ready') {
        const theme = document.body.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
        try {
          if (event.source && typeof event.source.postMessage === 'function') {
            event.source.postMessage({ type: 'nexushub-theme', theme: theme }, '*');
          }
        } catch (error) {
          console.warn('タイマーへのテーマ同期応答に失敗しました:', error);
        }

        if (timerLoadingIndicator) {
          timerLoadingIndicator.setAttribute('hidden', 'true');
        }
      }
    });

    setInterval(function() {
      if (timerPopupRef && timerPopupRef.closed) {
        timerPopupRef = null;
      }
    }, 5000);

    function updateClock() {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      
      const clockElement = document.getElementById('clock');
      if (clockElement) {
        clockElement.textContent = hours + ':' + minutes + ':' + seconds;
      }
      
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
      const weekday = weekdays[now.getDay()];
      
      const dateElement = document.getElementById('date');
      if (dateElement) {
        dateElement.textContent = year + '年' + month + '月' + day + '日 (' + weekday + ')';
      }
    }

    updateClock();
    setInterval(updateClock, 1000);

    function buildTimerUrl() {
      const timerUrl = new URL(window.location.href);
      timerUrl.searchParams.set('page', 'timer');
      timerUrl.hash = '';
      return timerUrl.toString();
    }

    function openTimerPopup(url) {
      const features = 'width=420,height=560,resizable=yes,scrollbars=yes';
      const popup = window.open(url, 'nexushub-timer', features);
      if (!popup) {
        return null;
      }

      try {
        popup.opener = window;
        if (popup.location && popup.location.href === 'about:blank') {
          popup.location.href = url;
        }
      } catch (error) {
        console.warn('タイマーポップアップの初期化に失敗しました:', error);
      }

      if (typeof popup.focus === 'function') {
        popup.focus();
      }

      timerPopupRef = popup;
      broadcastThemeToTimerSurfaces(document.body.getAttribute('data-theme') === 'dark' ? 'dark' : 'light');
      return popup;
    }

    function openTimerModal(url) {
      if (timerLoadingIndicator) {
        timerLoadingIndicator.removeAttribute('hidden');
      }

      if (timerIframeElement) {
        if (timerIframeElement.getAttribute('src') !== url) {
          timerIframeElement.setAttribute('src', url);
        } else if (timerIframeElement.contentWindow) {
          if (timerLoadingIndicator) {
            timerLoadingIndicator.setAttribute('hidden', 'true');
          }
          const theme = document.body.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
          timerIframeElement.contentWindow.postMessage({ type: 'nexushub-theme', theme: theme }, '*');
        }
      }

      if (timerModalElement) {
        timerModalElement.style.display = 'block';
      }
    }

    function openTimerWindow() {
      const timerUrl = buildTimerUrl();
      openTimerModal(timerUrl);
      const popup = openTimerPopup(timerUrl);
      if (!popup) {
        console.info('タイマーをポップアップで開けませんでした。モーダル表示を継続します。');
      }
    }

    function scrollToChat() {
      const chatCard = document.getElementById('chatCard');
      if (chatCard) {
        chatCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        chatCard.classList.add('highlight-card');
        setTimeout(function() {
          chatCard.classList.remove('highlight-card');
        }, 1600);
      }
    }

    google.script.run
      .withSuccessHandler(function(userInfo) {
        const emailElement = document.getElementById('userEmail');
        if (emailElement) {
          emailElement.textContent = userInfo.email;
        }
      })
      .withFailureHandler(function(error) {
        const emailElement = document.getElementById('userEmail');
        if (emailElement) {
          emailElement.textContent = '情報取得失敗';
        }
      })
      .getUserInfo();

    function updateSummaryDashboard() {
      const today = new Date();
      const dateStr = today.getFullYear() + '-' + 
                     String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                     String(today.getDate()).padStart(2, '0');
      
      google.script.run
        .withSuccessHandler(function(data) {
          if (data.success && data.events) {
            todayEventsData = data.events;
            const countElement = document.getElementById('summaryEventCount');
            if (countElement && countElement.querySelector) {
              const spanElement = countElement.querySelector('span');
              if (spanElement) {
                spanElement.textContent = data.events.length;
              }
            }
            
            const now = new Date();
            const upcomingEvents = data.events.filter(function(event) {
              return new Date(event.startTime) > now;
            });
            
            if (upcomingEvents.length > 0) {
              const nextEvent = upcomingEvents[0];
              nextEventData = nextEvent;
              const startTime = new Date(nextEvent.startTime);
              const timeStr = String(startTime.getHours()).padStart(2, '0') + ':' + 
                             String(startTime.getMinutes()).padStart(2, '0');
              
              const titleElement = document.getElementById('summaryNextEvent');
              if (titleElement) {
                titleElement.textContent = nextEvent.title.length > 15 ? 
                                          nextEvent.title.substring(0, 15) + '...' : 
                                          nextEvent.title;
              }
              
              const timeElement = document.getElementById('summaryNextEventTime');
              if (timeElement) {
                timeElement.textContent = timeStr + ' 開始';
              }
              
              const summaryElement = document.getElementById('nextEventSummary');
              if (summaryElement) {
                summaryElement.style.cursor = 'pointer';
              }
            } else {
              nextEventData = null;
              const titleElement = document.getElementById('summaryNextEvent');
              if (titleElement) {
                titleElement.textContent = '予定なし';
              }
              
              const timeElement = document.getElementById('summaryNextEventTime');
              if (timeElement) {
                timeElement.textContent = '';
              }
              
              const summaryElement = document.getElementById('nextEventSummary');
              if (summaryElement) {
                summaryElement.style.cursor = 'default';
              }
            }
          }
        })
        .getCalendarEvents(dateStr);
    }

    function showTodayEvents() {
      const today = new Date();
      const dateStr = today.getFullYear() + '-' + 
                     String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                     String(today.getDate()).padStart(2, '0');
      
      showDayEvents(dateStr);
    }

    function showNextEventDetail() {
      if (!nextEventData) return;
      
      const modal = document.getElementById('eventModal');
      const modalBody = document.getElementById('eventModalBody');
      const addBtn = document.getElementById('addEventFromDateBtn');
      
      const startTime = new Date(nextEventData.startTime);
      const endTime = new Date(nextEventData.endTime);
      
      const year = startTime.getFullYear();
      const month = startTime.getMonth() + 1;
      const day = startTime.getDate();
      const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
      const weekday = weekdays[startTime.getDay()];
      
      const titleElement = document.getElementById('eventModalTitle');
      if (titleElement) {
        titleElement.textContent = nextEventData.title;
      }
      
      if (addBtn) {
        addBtn.style.display = 'none';
      }
      
      let timeStr = '';
      if (nextEventData.isAllDay) {
        timeStr = '終日';
      } else {
        timeStr = String(startTime.getHours()).padStart(2, '0') + ':' + 
                 String(startTime.getMinutes()).padStart(2, '0') + ' - ' +
                 String(endTime.getHours()).padStart(2, '0') + ':' + 
                 String(endTime.getMinutes()).padStart(2, '0');
      }
      
      let detailHTML = '<div class="event-item">';
      detailHTML += '<div class="event-time">' + timeStr + '</div>';
      detailHTML += '<div class="event-title">' + escapeHtml(nextEventData.title) + '</div>';
      detailHTML += '<div class="event-details">📅 ' + year + '年' + month + '月' + day + '日 (' + weekday + ')</div>';
      if (nextEventData.location) {
        detailHTML += '<div class="event-details">📍 ' + escapeHtml(nextEventData.location) + '</div>';
      }
      if (nextEventData.description) {
        detailHTML += '<div class="event-details" style="margin-top: 10px;">' + escapeHtml(nextEventData.description) + '</div>';
      }
      detailHTML += '<div class="event-details" style="margin-top: 10px; color: #7F8C8D;">📅 ' + escapeHtml(nextEventData.calendarName) + '</div>';
      detailHTML += '</div>';
      
      if (modalBody) {
        modalBody.innerHTML = detailHTML;
      }
      
      if (modal) {
        modal.style.display = 'block';
      }
    }

    function loadGmailData() {
      google.script.run
        .withSuccessHandler(function(gmailData) {
          if (!gmailData.success) {
            const emailList = document.getElementById('emailList');
            if (emailList) {
              emailList.innerHTML = '<p style="text-align: center; color: #E74C3C; padding: 20px;">メールの取得に失敗しました</p>';
            }
            return;
          }
          
          const countElement = document.getElementById('summaryUnreadCount');
          if (countElement && countElement.querySelector) {
            const spanElement = countElement.querySelector('span');
            if (spanElement) {
              spanElement.textContent = gmailData.unreadCount;
            }
          }
          
          if (gmailData.unreadCount > 0) {
            const badge = document.getElementById('unreadBadge');
            if (badge) {
              badge.textContent = gmailData.unreadCount > 99 ? '99+' : gmailData.unreadCount;
              badge.style.display = 'block';
            }
          } else {
            const badge = document.getElementById('unreadBadge');
            if (badge) {
              badge.style.display = 'none';
            }
          }

          const emailSummarySubtitle = document.getElementById('summaryLatestEmail');
          if (emailSummarySubtitle) {
            if (gmailData.unreadCount > 0 && gmailData.latestEmails && gmailData.latestEmails.length > 0) {
              const firstEmail = gmailData.latestEmails[0];
              const subjectPreview = truncateText(firstEmail.subject || '(件名なし)', 24);
              emailSummarySubtitle.textContent = '最新: ' + subjectPreview;
            } else if (gmailData.unreadCount === 0) {
              emailSummarySubtitle.textContent = '最新の未読はありません';
            }
          }
          
          const emailList = document.getElementById('emailList');
          if (!emailList) return;

          if (gmailData.unreadCount === 0) {
            emailList.innerHTML = '<div class="no-unread-message"><span class="material-icons">check_circle</span><p>未読メールはありません</p></div>';
            return;
          }
          
          if (gmailData.latestEmails && gmailData.latestEmails.length > 0) {
            let emailHTML = '<ul class="email-list">';
            
            gmailData.latestEmails.forEach(function(email) {
              const date = new Date(email.date);
              const formattedDate = formatEmailDate(date);
              
              emailHTML += '<li class="email-item ' + (email.isUnread ? 'unread' : '') + '" onclick="showEmailThread(\'' + email.threadId + '\')">';
              emailHTML += '<div class="email-header">';
              emailHTML += '<span class="email-from">' + escapeHtml(email.from) + '</span>';
              emailHTML += '<span class="email-date">' + formattedDate + '</span>';
              emailHTML += '</div>';
              emailHTML += '<div class="email-subject">' + escapeHtml(email.subject) + '</div>';
              emailHTML += '<div class="email-snippet">' + escapeHtml(email.snippet) + '</div>';
              emailHTML += '</li>';
            });
            
            emailHTML += '</ul>';
            emailList.innerHTML = emailHTML;
          }
        })
        .withFailureHandler(function(error) {
          const emailList = document.getElementById('emailList');
          if (emailList) {
            emailList.innerHTML = '<p style="text-align: center; color: #E74C3C; padding: 20px;">メールの取得に失敗しました</p>';
          }
          const emailSummarySubtitle = document.getElementById('summaryLatestEmail');
          if (emailSummarySubtitle) {
            emailSummarySubtitle.textContent = 'メール情報の取得に失敗しました';
          }
        })
        .getGmailData();
    }

    function loadChatData() {
      google.script.run
        .withSuccessHandler(function(chatData) {
          const summaryCountElement = document.getElementById('summaryChatCount');
          const summaryLatestElement = document.getElementById('summaryChatLatest');
          const breakdownElement = document.getElementById('summaryChatBreakdown');
          const chatBadge = document.getElementById('chatBadge');
          const dmCountLabel = document.getElementById('chatDmCount');
          const spaceCountLabel = document.getElementById('chatSpaceCount');
          const dmList = document.getElementById('chatDmList');
          const spaceList = document.getElementById('chatSpaceList');
          const emptyState = document.getElementById('chatEmptyState');
          const updateEmptyState = function(message) {
            if (!emptyState) return;
            if (message) {
              emptyState.style.display = 'flex';
              const text = emptyState.querySelector('p');
              if (text) {
                text.textContent = message;
              }
            } else {
              emptyState.style.display = 'none';
            }
          };

          if (!chatData || !chatData.success) {
            if (summaryLatestElement) {
              summaryLatestElement.textContent = 'チャット情報の取得に失敗しました';
            }
            if (breakdownElement) {
              breakdownElement.innerHTML = '<span>DM 0件</span><span>スペース 0件</span>';
            }
            if (dmCountLabel) dmCountLabel.textContent = '0';
            if (spaceCountLabel) spaceCountLabel.textContent = '0';
            if (dmList) dmList.innerHTML = '<div class="chat-column-empty">チャット情報の取得に失敗しました</div>';
            if (spaceList) spaceList.innerHTML = '<div class="chat-column-empty">チャット情報の取得に失敗しました</div>';
            updateEmptyState('チャット情報の取得に失敗しました。');
            return;
          }

          const combinedConversations = Array.isArray(chatData.conversations) ? chatData.conversations : [];
          const directMessages = Array.isArray(chatData.directMessages) ? chatData.directMessages : [];
          const spaceMessages = Array.isArray(chatData.spaces) ? chatData.spaces : [];
          const latestConversation = chatData.latestConversation || combinedConversations[0] || null;

          const computedTotal = directMessages.length + spaceMessages.length;

          if (summaryCountElement && summaryCountElement.querySelector) {
            const spanElement = summaryCountElement.querySelector('span');
            if (spanElement) {
              spanElement.textContent = computedTotal;
            }
          }

          if (breakdownElement) {
            breakdownElement.innerHTML = '<span>DM ' + directMessages.length + '件</span><span>スペース ' + spaceMessages.length + '件</span>';
          }

          if (chatBadge) {
            if (computedTotal > 0) {
              chatBadge.textContent = computedTotal > 99 ? '99+' : computedTotal;
              chatBadge.style.display = 'block';
            } else {
              chatBadge.style.display = 'none';
            }
          }

          if (dmCountLabel) dmCountLabel.textContent = String(directMessages.length);
          if (spaceCountLabel) spaceCountLabel.textContent = String(spaceMessages.length);

          if (summaryLatestElement) {
            if (latestConversation) {
              const latestTitle = latestConversation.title || latestConversation.author || 'チャット';
              summaryLatestElement.textContent = '最新: ' + truncateText(latestTitle, 24);
            } else {
              summaryLatestElement.textContent = '最新の未読はありません';
            }
          }

          const renderChatEntries = function(container, items, emptyMessage) {
            if (!container) return;
            if (!items || items.length === 0) {
              container.innerHTML = '<div class="chat-column-empty">' + emptyMessage + '</div>';
              return;
            }

            let entries = '';
            items.forEach(function(conversation) {
              const lastUpdated = new Date(conversation.lastUpdated);
              const relativeTime = formatRelativeTime(lastUpdated);
              const title = escapeHtml(conversation.title || 'チャット');
              const author = escapeHtml(conversation.author || 'メンバー');
              const snippet = escapeHtml(conversation.preview || 'メッセージは表示できません');
              const permalink = conversation.permalink ? encodeURI(conversation.permalink) : '';

              entries += '<article class="chat-entry">';
              entries += '<div class="chat-entry-title">' + title + '</div>';
              entries += '<div class="chat-entry-meta"><span>' + author + '</span><span>' + relativeTime + '</span></div>';
              entries += '<p class="chat-entry-preview">' + snippet + '</p>';
              if (permalink) {
                entries += '<a class="chat-entry-link" href="' + permalink + '" target="_blank" rel="noopener">Chatで開く</a>';
              }
              entries += '</article>';
            });

            container.innerHTML = entries;
          };

          if (directMessages.length === 0 && spaceMessages.length === 0) {
            updateEmptyState('最新の未読チャットはありません。');
            renderChatEntries(dmList, directMessages, '未読のダイレクトメッセージはありません');
            renderChatEntries(spaceList, spaceMessages, '未読のスペースはありません');
            return;
          }

          updateEmptyState('');
          renderChatEntries(dmList, directMessages, '未読のダイレクトメッセージはありません');
          renderChatEntries(spaceList, spaceMessages, '未読のスペースはありません');
        })
        .withFailureHandler(function() {
          const summaryCountElement = document.getElementById('summaryChatCount');
          const summaryLatestElement = document.getElementById('summaryChatLatest');
          const breakdownElement = document.getElementById('summaryChatBreakdown');
          const dmList = document.getElementById('chatDmList');
          const spaceList = document.getElementById('chatSpaceList');
          const dmCountLabel = document.getElementById('chatDmCount');
          const spaceCountLabel = document.getElementById('chatSpaceCount');
          const emptyState = document.getElementById('chatEmptyState');
          const chatBadge = document.getElementById('chatBadge');
          if (summaryCountElement && summaryCountElement.querySelector) {
            const spanElement = summaryCountElement.querySelector('span');
            if (spanElement) {
              spanElement.textContent = 0;
            }
          }

          if (summaryLatestElement) {
            summaryLatestElement.textContent = 'チャット情報の取得に失敗しました';
          }

          if (breakdownElement) {
            breakdownElement.innerHTML = '<span>DM 0件</span><span>スペース 0件</span>';
          }

          if (dmCountLabel) dmCountLabel.textContent = '0';
          if (spaceCountLabel) spaceCountLabel.textContent = '0';
          if (dmList) dmList.innerHTML = '<div class="chat-column-empty">チャット情報の取得に失敗しました</div>';
          if (spaceList) spaceList.innerHTML = '<div class="chat-column-empty">チャット情報の取得に失敗しました</div>';
          if (emptyState) {
            emptyState.style.display = 'flex';
            const message = emptyState.querySelector('p');
            if (message) {
              message.textContent = 'チャット情報の取得に失敗しました。';
            }
          }
          if (chatBadge) {
            chatBadge.style.display = 'none';
          }
        })
        .getChatData();
    }

    function initializeQuickLaunch() {
      const launchGrid = document.getElementById('quickLaunchGrid');
      if (!launchGrid) {
        return;
      }

      launchGrid.addEventListener('click', function(event) {
        const origin = event.target;
        const target = origin && typeof origin.closest === 'function' ? origin.closest('.quick-launch-btn') : null;
        if (!target) {
          return;
        }

        const destination = target.getAttribute('data-url');
        if (!destination) {
          return;
        }

        const opened = window.open(destination, '_blank', 'noopener');
        if (!opened) {
          alert('ポップアップがブロックされました。別タブでの起動を許可してください。');
        }
      });
    }

    loadGmailData();
    loadChatData();
    updateSummaryDashboard();
    initializeQuickLaunch();

    emailRefreshInterval = setInterval(loadGmailData, 30000);
    chatRefreshInterval = setInterval(loadChatData, 30000);
    summaryRefreshInterval = setInterval(updateSummaryDashboard, 60000);

    function convertLinksToClickable(text) {
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex, function(url) {
        return '<a href="' + url + '" target="_blank">' + url + '</a>';
      });
    }

    function showEmailThread(threadId) {
      currentThreadId = threadId;
      const modal = document.getElementById('eventModal');
      const modalBody = document.getElementById('emailModalBody');
      const emailModal = document.getElementById('emailModal');
      
      const titleElement = document.getElementById('emailModalTitle');
      if (titleElement) {
        titleElement.textContent = 'メール';
      }
      
      if (modalBody) {
        modalBody.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>読み込み中...</p></div>';
      }
      
      if (emailModal) {
        emailModal.style.display = 'block';
      }
      
      google.script.run
        .withSuccessHandler(function() {
          loadGmailData();
        })
        .markThreadAsRead(threadId);
      
      google.script.run
        .withSuccessHandler(function(data) {
          if (!data.success) {
            if (modalBody) {
              modalBody.innerHTML = '<p class="no-events">メールの取得に失敗しました</p>';
            }
            return;
          }
          
          const messageCount = data.messages.length;
          const titleWithCount = data.subject + (messageCount > 1 ? ' (' + messageCount + '件)' : '');
          if (titleElement) {
            titleElement.textContent = titleWithCount;
          }
          
          let threadHTML = '';
          
          threadHTML += '<div class="gmail-reply-banner">';
          threadHTML += '<div class="gmail-reply-text">';
          threadHTML += '<span class="material-icons">reply</span>';
          threadHTML += '返信する場合はこちらから';
          threadHTML += '</div>';
          threadHTML += '<a href="https://mail.google.com/mail/u/0/#inbox/' + threadId + '" target="_blank" class="gmail-reply-btn">';
          threadHTML += '<span class="material-icons">open_in_new</span>';
          threadHTML += 'Gmailで開く';
          threadHTML += '</a>';
          threadHTML += '</div>';
          
          threadHTML += '<div class="email-thread">';
          
          data.messages.forEach(function(message, index) {
            const date = new Date(message.date);
            const formattedDate = date.getFullYear() + '年' + 
                                 (date.getMonth() + 1) + '月' + 
                                 date.getDate() + '日';
            const formattedTime = String(date.getHours()).padStart(2, '0') + ':' +
                                 String(date.getMinutes()).padStart(2, '0');
            
            const messageNumber = index + 1;
            
            threadHTML += '<div class="email-message">';
            threadHTML += '<div class="email-message-header">';
            threadHTML += '<div class="email-message-from">' + escapeHtml(message.from);
            if (messageCount > 1) {
              threadHTML += '<span class="email-count-badge">' + messageNumber + '/' + messageCount + '</span>';
            }
            threadHTML += '</div>';
            threadHTML += '<div class="email-message-meta">';
            threadHTML += '<div class="email-message-meta-row">';
            threadHTML += '<span class="material-icons">person</span>';
            threadHTML += '<span class="email-message-meta-label">宛先:</span>';
            threadHTML += '<span>' + escapeHtml(message.to) + '</span>';
            threadHTML += '</div>';
            threadHTML += '<div class="email-message-meta-row">';
            threadHTML += '<span class="material-icons">schedule</span>';
            threadHTML += '<span class="email-message-meta-label">日時:</span>';
            threadHTML += '<span>' + formattedDate + ' ' + formattedTime + '</span>';
            threadHTML += '</div>';
            threadHTML += '</div>';
            threadHTML += '</div>';
            
            const bodyWithLinks = convertLinksToClickable(escapeHtml(message.body));
            threadHTML += '<div class="email-message-body">' + bodyWithLinks + '</div>';
            
            if (message.attachments && message.attachments.length > 0) {
              threadHTML += '<div class="email-attachments">';
              threadHTML += '<div class="email-attachments-title">';
              threadHTML += '<span class="material-icons">attach_file</span>';
              threadHTML += '添付ファイル (' + message.attachments.length + '件)';
              threadHTML += '</div>';
              threadHTML += '<div class="attachment-list">';
              
              const actualIndex = data.messages.length - 1 - index;
              
              message.attachments.forEach(function(attachment, attIndex) {
                const sizeKB = (attachment.size / 1024).toFixed(1);
                const sizeMB = (attachment.size / (1024 * 1024)).toFixed(2);
                const sizeText = attachment.size > 1024 * 1024 ? sizeMB + ' MB' : sizeKB + ' KB';
                
                threadHTML += '<div class="attachment-item">';
                threadHTML += '<div class="attachment-info">';
                threadHTML += '<span class="material-icons attachment-icon">insert_drive_file</span>';
                threadHTML += '<div class="attachment-details">';
                threadHTML += '<div class="attachment-name">' + escapeHtml(attachment.name) + '</div>';
                threadHTML += '<div class="attachment-size">' + sizeText + '</div>';
                threadHTML += '</div>';
                threadHTML += '</div>';
                threadHTML += '<button class="attachment-download-btn" onclick="downloadAttachment(\'' + threadId + '\', ' + actualIndex + ', ' + attIndex + ')">';
                threadHTML += '<span class="material-icons">download</span>';
                threadHTML += 'ダウンロード';
                threadHTML += '</button>';
                threadHTML += '</div>';
              });
              
              threadHTML += '</div>';
              threadHTML += '</div>';
            }
            
            threadHTML += '</div>';
          });
          
          threadHTML += '</div>';
          if (modalBody) {
            modalBody.innerHTML = threadHTML;
          }
        })
        .withFailureHandler(function(error) {
          if (modalBody) {
            modalBody.innerHTML = '<p class="no-events">メールの取得に失敗しました</p>';
          }
        })
        .getEmailThread(threadId);
    }

    function downloadAttachment(threadId, messageIndex, attachmentIndex) {
      const btn = event.target.closest('.attachment-download-btn');
      if (!btn) return;
      
      const originalHTML = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="material-icons">hourglass_empty</span>処理中...';
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            const byteCharacters = atob(result.data);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
              byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: result.contentType });
            
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = result.name;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            btn.disabled = false;
            btn.innerHTML = '<span class="material-icons">check</span>完了';
            setTimeout(function() {
              btn.innerHTML = originalHTML;
            }, 2000);
          } else {
            alert('ダウンロードに失敗しました: ' + result.error);
            btn.disabled = false;
            btn.innerHTML = originalHTML;
          }
        })
        .withFailureHandler(function(error) {
          alert('ダウンロードに失敗しました');
          btn.disabled = false;
          btn.innerHTML = originalHTML;
        })
        .downloadAttachment(threadId, messageIndex, attachmentIndex);
    }

    function loadTodoList() {
      google.script.run
        .withSuccessHandler(function(todoData) {
          const todoList = document.getElementById('todoList');
          if (!todoList) return;
          
          if (!todoData.success) {
            todoList.innerHTML = '<p style="text-align: center; color: #E74C3C; padding: 20px;">Todoの取得に失敗しました</p>';
            return;
          }
          
          currentTaskLists = todoData.taskLists;
          
          if (todoData.tasks && todoData.tasks.length > 0) {
            let todoHTML = '<ul class="todo-list">';
            
            todoData.tasks.forEach(function(task) {
              let dueText = '';
              if (task.due) {
                const dueDate = new Date(task.due);
                dueText = '<span class="todo-due">' + formatTodoDate(dueDate) + '</span>';
              }
              
              todoHTML += '<li class="todo-item">';
              todoHTML += '<div class="todo-main">';
              todoHTML += '<div class="todo-content" onclick="editTodo(\'' + task.id + '\', \'' + task.listId + '\', \'' + escapeHtml(task.title).replace(/'/g, "\\'") + '\', \'' + (task.due || '') + '\', \'' + escapeHtml(task.notes || '').replace(/'/g, "\\'") + '\')">';
              todoHTML += '<div class="todo-title">' + escapeHtml(task.title) + '</div>';
              todoHTML += '<div class="todo-meta">';
              todoHTML += '<span>' + escapeHtml(task.listName) + '</span>';
              if (dueText) todoHTML += dueText;
              todoHTML += '</div>';
              todoHTML += '</div>';
              todoHTML += '<div class="todo-actions">';
              todoHTML += '<button class="todo-action-btn complete" onclick="event.stopPropagation(); completeTodo(\'' + task.id + '\', \'' + task.listId + '\')" title="完了">';
              todoHTML += '<span class="material-icons">check_circle</span>';
              todoHTML += '</button>';
              todoHTML += '<button class="todo-action-btn delete" onclick="event.stopPropagation(); deleteTodo(\'' + task.id + '\', \'' + task.listId + '\')" title="削除">';
              todoHTML += '<span class="material-icons">delete</span>';
              todoHTML += '</button>';
              todoHTML += '</div>';
              todoHTML += '</div>';
              
              if (task.subtasks && task.subtasks.length > 0) {
                todoHTML += '<div class="subtasks">';
                task.subtasks.forEach(function(subtask) {
                  todoHTML += '<div class="subtask-item">';
                  todoHTML += '<span class="material-icons">subdirectory_arrow_right</span>';
                  todoHTML += '<span>' + escapeHtml(subtask.title) + '</span>';
                  todoHTML += '</div>';
                });
                todoHTML += '</div>';
              }
              
              todoHTML += '</li>';
            });
            
            todoHTML += '</ul>';
            todoList.innerHTML = todoHTML;
          } else {
            todoList.innerHTML = '<p style="text-align: center; color: #95A5A6; padding: 20px;">Todoがありません</p>';
          }
        })
        .withFailureHandler(function(error) {
          const todoList = document.getElementById('todoList');
          if (todoList) {
            todoList.innerHTML = '<p style="text-align: center; color: #E74C3C; padding: 20px;">Todoの取得に失敗しました</p>';
          }
        })
        .getTodoTasks();
    }

    loadTodoList();

    function openTodoModal() {
      editingTodoId = null;
      editingTodoListId = null;
      const titleElement = document.getElementById('todoModalTitle');
      if (titleElement) titleElement.textContent = '新規タスク';
      
      const titleInput = document.getElementById('todoTitleInput');
      if (titleInput) titleInput.value = '';
      
      const dueDateInput = document.getElementById('todoDueDateInput');
      if (dueDateInput) dueDateInput.value = '';
      
      const notesInput = document.getElementById('todoNotesInput');
      if (notesInput) notesInput.value = '';
      
      const modal = document.getElementById('todoModal');
      if (modal) modal.style.display = 'block';
    }

    function editTodo(taskId, listId, title, dueDate, notes) {
      editingTodoId = taskId;
      editingTodoListId = listId;
      
      const titleElement = document.getElementById('todoModalTitle');
      if (titleElement) titleElement.textContent = 'タスク編集';
      
      const titleInput = document.getElementById('todoTitleInput');
      if (titleInput) titleInput.value = title;
      
      const notesInput = document.getElementById('todoNotesInput');
      if (notesInput) notesInput.value = notes || '';
      
      if (dueDate) {
        const date = new Date(dueDate);
        const dateStr = date.getFullYear() + '-' + 
                       String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                       String(date.getDate()).padStart(2, '0');
        const dueDateInput = document.getElementById('todoDueDateInput');
        if (dueDateInput) dueDateInput.value = dateStr;
      } else {
        const dueDateInput = document.getElementById('todoDueDateInput');
        if (dueDateInput) dueDateInput.value = '';
      }
      
      const modal = document.getElementById('todoModal');
      if (modal) modal.style.display = 'block';
    }

    function saveTodo() {
      const titleInput = document.getElementById('todoTitleInput');
      const dueDateInput = document.getElementById('todoDueDateInput');
      const notesInput = document.getElementById('todoNotesInput');
      
      const title = titleInput ? titleInput.value.trim() : '';
      const dueDate = dueDateInput ? dueDateInput.value || null : null;
      const notes = notesInput ? notesInput.value.trim() || null : null;
      
      if (!title) {
        alert('タスク名を入力してください');
        return;
      }
      
      closeModal('todoModal');
      const todoList = document.getElementById('todoList');
      if (todoList) {
        todoList.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>保存中...</p></div>';
      }
      
      if (editingTodoId) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              loadTodoList();
              loadMonthEvents();
            } else {
              alert('タスクの更新に失敗しました');
              loadTodoList();
            }
          })
          .withFailureHandler(function(error) {
            alert('タスクの更新に失敗しました');
            loadTodoList();
          })
          .updateTodoTask(editingTodoId, editingTodoListId, title, dueDate, notes);
      } else {
        const listId = currentTaskLists.length > 0 ? currentTaskLists[0].id : null;
        
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              loadTodoList();
              loadMonthEvents();
            } else {
              alert('タスクの追加に失敗しました');
              loadTodoList();
            }
          })
          .withFailureHandler(function(error) {
            alert('タスクの追加に失敗しました');
            loadTodoList();
          })
          .addTodoTask(title, listId, dueDate, notes);
      }
    }

    function completeTodo(taskId, listId) {
      if (!confirm('このタスクを完了しますか?')) return;
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            loadTodoList();
            loadMonthEvents();
          } else {
            alert('タスクの完了に失敗しました');
          }
        })
        .withFailureHandler(function(error) {
          alert('タスクの完了に失敗しました');
        })
        .completeTodoTask(taskId, listId);
    }

    function deleteTodo(taskId, listId) {
      if (!confirm('このタスクを削除しますか?')) return;
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            loadTodoList();
            loadMonthEvents();
          } else {
            alert('タスクの削除に失敗しました');
          }
        })
        .withFailureHandler(function(error) {
          alert('タスクの削除に失敗しました');
        })
        .deleteTodoTask(taskId, listId);
    }

    function renderFolderWithChildren(folder, level) {
      const folderLinks = allLinks.filter(link => link.folderId === folder.id);
      const childFolders = allFolders.filter(f => f.parentFolderId === folder.id);
      const isCollapsed = collapsedFolders[folder.id] || false;
      const nestedClass = level > 0 ? ' nested' : '';
      
      let html = '';
      html += '<div class="folder-container' + nestedClass + '">';
      html += '<div class="folder-header ' + (isCollapsed ? 'collapsed' : '') + '" data-folder-id="' + folder.id + '" onclick="toggleFolder(\'' + folder.id + '\')">';
      html += '<div class="folder-left">';
      html += '<span class="material-icons folder-icon" style="color: ' + folder.color + ';">folder</span>';
      html += '<span class="folder-name">' + escapeHtml(folder.name) + '</span>';
      html += '<span class="folder-count">(' + folderLinks.length + ')</span>';
      html += '</div>';
      html += '<div class="folder-actions" onclick="event.stopPropagation();">';
      html += '<button class="folder-action-btn edit" onclick="editFolder(\'' + folder.id + '\', \'' + escapeHtml(folder.name).replace(/'/g, "\\'") + '\', \'' + folder.color + '\', \'' + (folder.parentFolderId || '') + '\')" title="編集">';
      html += '<span class="material-icons">edit</span>';
      html += '</button>';
      html += '<button class="folder-action-btn delete" onclick="deleteFolder(\'' + folder.id + '\')" title="削除">';
      html += '<span class="material-icons">delete</span>';
      html += '</button>';
      html += '</div>';
      html += '</div>';
      
      html += '<div class="folder-links' + (isCollapsed ? ' collapsed' : '') + '" data-folder-id="' + folder.id + '">';
      if (!isCollapsed) {
        folderLinks.forEach(function(link) {
          html += renderLinkItem(link);
        });
      }
      html += '</div>';
      
      if (!isCollapsed) {
        childFolders.forEach(function(childFolder) {
          html += renderFolderWithChildren(childFolder, level + 1);
        });
      }
      
      html += '</div>';
      
      return html;
    }

    function renderLinkItem(link) {
      let html = '<div class="custom-link-item" data-link-id="' + link.id + '">';
      html += '<div class="custom-link-content">';
      html += '<a href="' + escapeHtml(link.url) + '" target="_blank">';
      
      if (link.faviconUrl) {
        html += '<img src="' + escapeHtml(link.faviconUrl) + '" class="link-favicon" onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'inline-flex\';" alt="" />';
        html += '<span class="material-icons icon-hidden">' + escapeHtml(link.icon) + '</span>';
      } else {
        html += '<span class="material-icons icon-only">' + escapeHtml(link.icon) + '</span>';
      }
      
      html += escapeHtml(link.title);
      html += '</a>';
      html += '</div>';
      html += '<div class="custom-link-actions">';
      html += '<button class="link-action-btn edit" onclick="editLink(\'' + link.id + '\', \'' + escapeHtml(link.title).replace(/'/g, "\\'") + '\', \'' + escapeHtml(link.url).replace(/'/g, "\\'") + '\', \'' + link.icon + '\', \'' + (link.folderId || '') + '\')" title="編集">';
      html += '<span class="material-icons">edit</span>';
      html += '</button>';
      html += '<button class="link-action-btn delete" onclick="deleteLink(\'' + link.id + '\')" title="削除">';
      html += '<span class="material-icons">delete</span>';
      html += '</button>';
      html += '</div>';
      html += '</div>';
      return html;
    }

    function loadUserLinks() {
      google.script.run
        .withSuccessHandler(function(result) {
          const linksList = document.getElementById('customLinksList');
          if (!linksList) return;
          
          if (!result.success) {
            linksList.innerHTML = '<p class="no-links-message">リンクの取得に失敗しました</p>';
            return;
          }
          
          allFolders = result.folders || [];
          allLinks = result.links || [];
          
          allFolders.forEach(function(folder) {
            if (!(folder.id in collapsedFolders)) {
              collapsedFolders[folder.id] = true;
            }
          });
          
          updateFolderSelects();
          
          if (allFolders.length === 0 && allLinks.length === 0) {
            linksList.innerHTML = '<p class="no-links-message">リンクがありません</p>';
            return;
          }
          
          let linksHTML = '';
          
          const topLevelFolders = allFolders.filter(f => !f.parentFolderId);
          
          topLevelFolders.forEach(function(folder) {
            linksHTML += renderFolderWithChildren(folder, 0);
          });
          
          const unfoldered = allLinks.filter(link => !link.folderId);
          if (unfoldered.length > 0) {
            linksHTML += '<div class="custom-links-list">';
            unfoldered.forEach(function(link) {
              linksHTML += renderLinkItem(link);
            });
            linksHTML += '</div>';
          }
          
          linksList.innerHTML = linksHTML;
        })
        .withFailureHandler(function(error) {
          const linksList = document.getElementById('customLinksList');
          if (linksList) {
            linksList.innerHTML = '<p class="no-links-message">リンクの取得に失敗しました</p>';
          }
        })
        .getUserLinks();
    }

    function openReorderModal() {
      const modal = document.getElementById('reorderModal');
      const content = document.getElementById('reorderContent');
      
      if (modal) modal.style.display = 'block';
      if (content) {
        content.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>読み込み中...</p></div>';
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (!result.success) {
            if (content) {
              content.innerHTML = '<p class="reorder-empty">データの取得に失敗しました</p>';
            }
            return;
          }
          
          allFolders = result.folders || [];
          allLinks = result.links || [];
          
          renderReorderContent();
        })
        .withFailureHandler(function(error) {
          if (content) {
            content.innerHTML = '<p class="reorder-empty">データの取得に失敗しました</p>';
          }
        })
        .getUserLinks();
    }

    function renderReorderContent() {
      const content = document.getElementById('reorderContent');
      if (!content) return;
      
      let html = '';
      
      const topLevelFolders = allFolders.filter(f => !f.parentFolderId);
      if (topLevelFolders.length > 0) {
        html += '<div class="reorder-section">';
        html += '<div class="reorder-section-title">';
        html += '<span class="material-icons">folder</span>';
        html += 'フォルダの並び替え';
        html += '</div>';
        html += '<div class="reorder-list">';
        
        topLevelFolders.forEach(function(folder, index) {
          html += renderReorderFolder(folder, index, topLevelFolders.length, null);
          
          const childFolders = allFolders.filter(f => f.parentFolderId === folder.id);
          childFolders.forEach(function(childFolder, childIndex) {
            html += renderReorderFolder(childFolder, childIndex, childFolders.length, folder.id, true);
          });
        });
        
        html += '</div>';
        html += '</div>';
      }
      
      html += '<div class="reorder-section">';
      html += '<div class="reorder-section-title">';
      html += '<span class="material-icons">link</span>';
      html += 'リンクの並び替え';
      html += '</div>';
      
      const unfoldered = allLinks.filter(link => !link.folderId);
      if (unfoldered.length > 0) {
        html += '<div style="margin-bottom: 20px;">';
        html += '<div style="font-size: 13px; font-weight: 600; color: #9fa8da; margin-bottom: 8px; padding-left: 5px;">フォルダなし</div>';
        html += '<div class="reorder-list">';
        unfoldered.forEach(function(link, index) {
          html += renderReorderLink(link, index, unfoldered.length, null);
        });
        html += '</div>';
        html += '</div>';
      }
      
      allFolders.forEach(function(folder) {
        const folderLinks = allLinks.filter(link => link.folderId === folder.id);
        if (folderLinks.length > 0) {
          html += '<div style="margin-bottom: 20px;">';
          html += '<div style="font-size: 13px; font-weight: 600; color: ' + folder.color + '; margin-bottom: 8px; padding-left: 5px; display: flex; align-items: center; gap: 6px;">';
          html += '<span class="material-icons" style="font-size: 18px;">folder</span>';
          html += escapeHtml(folder.name);
          html += '</div>';
          html += '<div class="reorder-list">';
          folderLinks.forEach(function(link, index) {
            html += renderReorderLink(link, index, folderLinks.length, folder.id);
          });
          html += '</div>';
          html += '</div>';
        }
      });
      
      html += '</div>';
      
      if (allLinks.length > 0) {
        html += '<div class="reorder-section folder-move-section">';
        html += '<div class="reorder-section-title">';
        html += '<span class="material-icons">drive_file_move</span>';
        html += 'リンクをフォルダに移動';
        html += '</div>';
        
        allLinks.forEach(function(link) {
          html += '<div class="folder-move-item">';
          html += '<div style="flex: 0 0 auto; min-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 13px; color: #e8eaf6;">';
          html += escapeHtml(link.title);
          html += '</div>';
          html += '<select class="folder-move-select" id="moveSelect_' + link.id + '">';
          html += '<option value="">フォルダなし</option>';
          allFolders.forEach(function(folder) {
            const selected = link.folderId === folder.id ? ' selected' : '';
            html += '<option value="' + folder.id + '"' + selected + '>' + escapeHtml(folder.name) + '</option>';
          });
          html += '</select>';
          html += '<button class="folder-move-btn" onclick="moveLinkToFolderAction(\'' + link.id + '\')">移動</button>';
          html += '</div>';
        });
        
        html += '</div>';
      }
      
      content.innerHTML = html;
    }

    function renderReorderFolder(folder, index, total, parentFolderId, isChild) {
      const indent = isChild ? 'margin-left: 30px;' : '';
      let html = '<div class="reorder-item" style="' + indent + '">';
      html += '<div class="reorder-item-content">';
      html += '<span class="material-icons reorder-item-icon" style="color: ' + folder.color + ';">folder</span>';
      html += '<span class="reorder-item-text">' + escapeHtml(folder.name) + '</span>';
      
      const childCount = allFolders.filter(f => f.parentFolderId === folder.id).length;
      const linkCount = allLinks.filter(link => link.folderId === folder.id).length;
      if (childCount > 0 || linkCount > 0) {
        html += '<span class="reorder-item-badge">';
        if (childCount > 0) html += childCount + '個のフォルダ ';
        if (linkCount > 0) html += linkCount + '個のリンク';
        html += '</span>';
      }
      
      html += '</div>';
      html += '<div class="reorder-controls">';
      
      const disabledTop = index === 0 ? ' disabled' : '';
      const disabledUp = index === 0 ? ' disabled' : '';
      const disabledDown = index === total - 1 ? ' disabled' : '';
      const disabledBottom = index === total - 1 ? ' disabled' : '';
      
      html += '<button class="reorder-btn" onclick="moveFolderAction(\'' + folder.id + '\', \'top\', \'' + (parentFolderId || '') + '\')" title="最上部へ"' + disabledTop + '>';
      html += '<span class="material-icons">vertical_align_top</span>';
      html += '</button>';
      
      html += '<button class="reorder-btn" onclick="moveFolderAction(\'' + folder.id + '\', \'up\', \'' + (parentFolderId || '') + '\')" title="上へ"' + disabledUp + '>';
      html += '<span class="material-icons">keyboard_arrow_up</span>';
      html += '</button>';
      
      html += '<button class="reorder-btn" onclick="moveFolderAction(\'' + folder.id + '\', \'down\', \'' + (parentFolderId || '') + '\')" title="下へ"' + disabledDown + '>';
      html += '<span class="material-icons">keyboard_arrow_down</span>';
      html += '</button>';
      
      html += '<button class="reorder-btn" onclick="moveFolderAction(\'' + folder.id + '\', \'bottom\', \'' + (parentFolderId || '') + '\')" title="最下部へ"' + disabledBottom + '>';
      html += '<span class="material-icons">vertical_align_bottom</span>';
      html += '</button>';
      
      html += '</div>';
      html += '</div>';
      
      return html;
    }

    function renderReorderLink(link, index, total, folderId) {
      let html = '<div class="reorder-item">';
      html += '<div class="reorder-item-content">';
      
      if (link.faviconUrl) {
        html += '<img src="' + escapeHtml(link.faviconUrl) + '" class="link-favicon" style="width: 20px; height: 20px; flex-shrink: 0;" onerror="this.style.display=\'none\';" alt="" />';
      } else {
        html += '<span class="material-icons reorder-item-icon" style="color: #667eea;">' + escapeHtml(link.icon) + '</span>';
      }
      
      html += '<span class="reorder-item-text">' + escapeHtml(link.title) + '</span>';
      html += '</div>';
      html += '<div class="reorder-controls">';
      
      const disabledTop = index === 0 ? ' disabled' : '';
      const disabledUp = index === 0 ? ' disabled' : '';
      const disabledDown = index === total - 1 ? ' disabled' : '';
      const disabledBottom = index === total - 1 ? ' disabled' : '';
      
      html += '<button class="reorder-btn" onclick="moveLinkAction(\'' + link.id + '\', \'top\', \'' + (folderId || '') + '\')" title="最上部へ"' + disabledTop + '>';
      html += '<span class="material-icons">vertical_align_top</span>';
      html += '</button>';
      
      html += '<button class="reorder-btn" onclick="moveLinkAction(\'' + link.id + '\', \'up\', \'' + (folderId || '') + '\')" title="上へ"' + disabledUp + '>';
      html += '<span class="material-icons">keyboard_arrow_up</span>';
      html += '</button>';
      
      html += '<button class="reorder-btn" onclick="moveLinkAction(\'' + link.id + '\', \'down\', \'' + (folderId || '') + '\')" title="下へ"' + disabledDown + '>';
      html += '<span class="material-icons">keyboard_arrow_down</span>';
      html += '</button>';
      
      html += '<button class="reorder-btn" onclick="moveLinkAction(\'' + link.id + '\', \'bottom\', \'' + (folderId || '') + '\')" title="最下部へ"' + disabledBottom + '>';
      html += '<span class="material-icons">vertical_align_bottom</span>';
      html += '</button>';
      
      html += '</div>';
      html += '</div>';
      
      return html;
    }

    function moveLinkAction(linkId, direction, folderId) {
      const content = document.getElementById('reorderContent');
      if (content) {
        content.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>移動中...</p></div>';
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            google.script.run
              .withSuccessHandler(function(result) {
                if (result.success) {
                  allFolders = result.folders || [];
                  allLinks = result.links || [];
                  renderReorderContent();
                  loadUserLinks();
                }
              })
              .getUserLinks();
          } else {
            alert('移動に失敗しました: ' + (result.error || ''));
            openReorderModal();
          }
        })
        .withFailureHandler(function(error) {
          alert('移動に失敗しました');
          openReorderModal();
        })
        .moveLink(linkId, direction, folderId || null);
    }

    function moveFolderAction(folderId, direction, parentFolderId) {
      const content = document.getElementById('reorderContent');
      if (content) {
        content.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>移動中...</p></div>';
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            google.script.run
              .withSuccessHandler(function(result) {
                if (result.success) {
                  allFolders = result.folders || [];
                  allLinks = result.links || [];
                  renderReorderContent();
                  loadUserLinks();
                }
              })
              .getUserLinks();
          } else {
            alert('移動に失敗しました: ' + (result.error || ''));
            openReorderModal();
          }
        })
        .withFailureHandler(function(error) {
          alert('移動に失敗しました');
          openReorderModal();
        })
        .moveFolder(folderId, direction, parentFolderId || null);
    }

    function moveLinkToFolderAction(linkId) {
      const select = document.getElementById('moveSelect_' + linkId);
      if (!select) return;
      
      const targetFolderId = select.value || null;
      
      const content = document.getElementById('reorderContent');
      if (content) {
        content.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>移動中...</p></div>';
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            google.script.run
              .withSuccessHandler(function(result) {
                if (result.success) {
                  allFolders = result.folders || [];
                  allLinks = result.links || [];
                  renderReorderContent();
                  loadUserLinks();
                }
              })
              .getUserLinks();
          } else {
            alert('移動に失敗しました: ' + (result.error || ''));
            openReorderModal();
          }
        })
        .withFailureHandler(function(error) {
          alert('移動に失敗しました');
          openReorderModal();
        })
        .moveLinkToFolder(linkId, targetFolderId);
    }

    function toggleFolder(folderId) {
      collapsedFolders[folderId] = !collapsedFolders[folderId];
      
      const linksList = document.getElementById('customLinksList');
      if (!linksList) return;
      
      let linksHTML = '';
      
      const topLevelFolders = allFolders.filter(f => !f.parentFolderId);
      
      topLevelFolders.forEach(function(folder) {
        linksHTML += renderFolderWithChildren(folder, 0);
      });
      
      const unfoldered = allLinks.filter(link => !link.folderId);
      if (unfoldered.length > 0) {
        linksHTML += '<div class="custom-links-list">';
        unfoldered.forEach(function(link) {
          linksHTML += renderLinkItem(link);
        });
        linksHTML += '</div>';
      }
      
      linksList.innerHTML = linksHTML;
    }

    function getFolderIndent(folderId) {
      let indent = '';
      let currentId = folderId;
      let level = 0;
      
      while (currentId && level < 10) {
        const folder = allFolders.find(f => f.id === currentId);
        if (folder && folder.parentFolderId) {
          indent = '　' + indent;
          currentId = folder.parentFolderId;
          level++;
        } else {
          break;
        }
      }
      
      return indent;
    }

    function updateFolderSelects(excludeFolderId) {
      const folderSelect = document.getElementById('linkFolderInput');
      const parentFolderSelect = document.getElementById('folderParentInput');
      
      if (folderSelect) {
        let options = '<option value="">フォルダなし</option>';
        allFolders.forEach(function(folder) {
          const indent = getFolderIndent(folder.id);
          options += '<option value="' + folder.id + '">' + indent + escapeHtml(folder.name) + '</option>';
        });
        folderSelect.innerHTML = options;
      }
      
      if (parentFolderSelect) {
        let options = '<option value="">なし（トップレベル）</option>';
        allFolders.forEach(function(folder) {
          if (folder.id !== excludeFolderId) {
            const indent = getFolderIndent(folder.id);
            options += '<option value="' + folder.id + '">' + indent + escapeHtml(folder.name) + '</option>';
          }
        });
        parentFolderSelect.innerHTML = options;
      }
    }

    loadUserLinks();

    function openLinkModal() {
      editingLinkId = null;
      
      const titleElement = document.getElementById('linkModalTitle');
      if (titleElement) titleElement.textContent = 'リンクを追加';
      
      const titleInput = document.getElementById('linkTitleInput');
      if (titleInput) titleInput.value = '';
      
      const urlInput = document.getElementById('linkUrlInput');
      if (urlInput) urlInput.value = '';
      
      const iconInput = document.getElementById('linkIconInput');
      if (iconInput) iconInput.value = 'code';
      
      const folderInput = document.getElementById('linkFolderInput');
      if (folderInput) folderInput.value = '';
      
      const modal = document.getElementById('linkModal');
      if (modal) modal.style.display = 'block';
    }

    function editLink(linkId, title, url, icon, folderId) {
      editingLinkId = linkId;
      
      const titleElement = document.getElementById('linkModalTitle');
      if (titleElement) titleElement.textContent = 'リンクを編集';
      
      const titleInput = document.getElementById('linkTitleInput');
      if (titleInput) titleInput.value = title;
      
      const urlInput = document.getElementById('linkUrlInput');
      if (urlInput) urlInput.value = url;
      
      const iconInput = document.getElementById('linkIconInput');
      if (iconInput) iconInput.value = icon;
      
      const folderInput = document.getElementById('linkFolderInput');
      if (folderInput) folderInput.value = folderId || '';
      
      const modal = document.getElementById('linkModal');
      if (modal) modal.style.display = 'block';
    }

    function saveLink() {
      const titleInput = document.getElementById('linkTitleInput');
      const urlInput = document.getElementById('linkUrlInput');
      const iconInput = document.getElementById('linkIconInput');
      const folderInput = document.getElementById('linkFolderInput');
      
      const title = titleInput ? titleInput.value.trim() : '';
      const url = urlInput ? urlInput.value.trim() : '';
      const icon = iconInput ? iconInput.value : 'code';
      const folderId = folderInput ? folderInput.value || null : null;
      
      if (!title || !url) {
        alert('タイトルとURLは必須です');
        return;
      }
      
      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        alert('URLは http:// または https:// で始まる必要があります');
        return;
      }
      
      closeModal('linkModal');
      const linksList = document.getElementById('customLinksList');
      if (linksList) {
        linksList.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>保存中...</p></div>';
      }
      
      if (editingLinkId) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              loadUserLinks();
            } else {
              alert('リンクの更新に失敗しました');
              loadUserLinks();
            }
          })
          .withFailureHandler(function(error) {
            alert('リンクの更新に失敗しました');
            loadUserLinks();
          })
          .updateUserLink(editingLinkId, title, url, icon, folderId);
      } else {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              loadUserLinks();
            } else {
              alert('リンクの追加に失敗しました');
              loadUserLinks();
            }
          })
          .withFailureHandler(function(error) {
            alert('リンクの追加に失敗しました');
            loadUserLinks();
          })
          .saveUserLink(title, url, icon, folderId);
      }
    }

    function deleteLink(linkId) {
      if (!confirm('このリンクを削除しますか?')) return;
      
      const linksList = document.getElementById('customLinksList');
      if (linksList) {
        linksList.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>削除中...</p></div>';
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            loadUserLinks();
          } else {
            alert('リンクの削除に失敗しました');
            loadUserLinks();
          }
        })
        .withFailureHandler(function(error) {
          alert('リンクの削除に失敗しました');
          loadUserLinks();
        })
        .deleteUserLink(linkId);
    }

    function openFolderModal() {
      editingFolderId = null;
      selectedColor = '#667eea';
      
      const titleElement = document.getElementById('folderModalTitle');
      if (titleElement) titleElement.textContent = 'フォルダを追加';
      
      const nameInput = document.getElementById('folderNameInput');
      if (nameInput) nameInput.value = '';
      
      const parentFolderInput = document.getElementById('folderParentInput');
      if (parentFolderInput) parentFolderInput.value = '';
      
      updateColorSelection();
      updateFolderSelects();
      
      const modal = document.getElementById('folderModal');
      if (modal) modal.style.display = 'block';
    }

    function editFolder(folderId, name, color, parentFolderId) {
      editingFolderId = folderId;
      selectedColor = color;
      
      const titleElement = document.getElementById('folderModalTitle');
      if (titleElement) titleElement.textContent = 'フォルダを編集';
      
      const nameInput = document.getElementById('folderNameInput');
      if (nameInput) nameInput.value = name;
      
      updateColorSelection();
      updateFolderSelects(folderId);
      
      const parentFolderInput = document.getElementById('folderParentInput');
      if (parentFolderInput) {
        parentFolderInput.value = parentFolderId || '';
      }
      
      const modal = document.getElementById('folderModal');
      if (modal) modal.style.display = 'block';
    }

    function selectColor(color) {
      selectedColor = color;
      updateColorSelection();
    }

    function updateColorSelection() {
      const colorOptions = document.querySelectorAll('.color-option');
      colorOptions.forEach(function(option) {
        if (option.dataset.color === selectedColor) {
          option.classList.add('selected');
        } else {
          option.classList.remove('selected');
        }
      });
    }

    function saveFolder() {
      const nameInput = document.getElementById('folderNameInput');
      const parentFolderInput = document.getElementById('folderParentInput');
      
      const name = nameInput ? nameInput.value.trim() : '';
      const parentFolderId = parentFolderInput ? (parentFolderInput.value || null) : null;
      
      if (!name) {
        alert('フォルダ名を入力してください');
        return;
      }
      
      closeModal('folderModal');
      const linksList = document.getElementById('customLinksList');
      if (linksList) {
        linksList.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>保存中...</p></div>';
      }
      
      if (editingFolderId) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              loadUserLinks();
            } else {
              alert(result.error || 'フォルダの更新に失敗しました');
              loadUserLinks();
            }
          })
          .withFailureHandler(function(error) {
            alert('フォルダの更新に失敗しました');
            loadUserLinks();
          })
          .updateUserFolder(editingFolderId, name, selectedColor, parentFolderId);
      } else {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              loadUserLinks();
            } else {
              alert('フォルダの追加に失敗しました');
              loadUserLinks();
            }
          })
          .withFailureHandler(function(error) {
            alert('フォルダの追加に失敗しました');
            loadUserLinks();
          })
          .saveUserFolder(name, selectedColor, parentFolderId);
      }
    }

    function deleteFolder(folderId) {
      if (!confirm('このフォルダを削除しますか？\n（フォルダ内のリンクは「フォルダなし」に移動されます）')) return;
      
      const linksList = document.getElementById('customLinksList');
      if (linksList) {
        linksList.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>削除中...</p></div>';
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            delete collapsedFolders[folderId];
            loadUserLinks();
          } else {
            alert('フォルダの削除に失敗しました');
            loadUserLinks();
          }
        })
        .withFailureHandler(function(error) {
          alert('フォルダの削除に失敗しました');
          loadUserLinks();
        })
        .deleteUserFolder(folderId);
    }

    function renderCalendar() {
      const firstDay = new Date(currentYear, currentMonth - 1, 1);
      const lastDay = new Date(currentYear, currentMonth, 0);
      const prevLastDay = new Date(currentYear, currentMonth - 1, 0);
      
      const firstDayOfWeek = firstDay.getDay();
      const lastDate = lastDay.getDate();
      const prevLastDate = prevLastDay.getDate();
      
      const monthElement = document.getElementById('calendarMonth');
      if (monthElement) {
        monthElement.textContent = currentYear + '年' + currentMonth + '月';
      }
      
      let calendarHTML = '';
      const dayHeaders = ['日', '月', '火', '水', '木', '金', '土'];
      dayHeaders.forEach(function(day) {
        calendarHTML += '<div class="calendar-day-header">' + day + '</div>';
      });
      
      for (let i = firstDayOfWeek - 1; i >= 0; i--) {
        const day = prevLastDate - i;
        calendarHTML += '<div class="calendar-day other-month">' + day + '</div>';
      }
      
      const today = new Date();
      for (let day = 1; day <= lastDate; day++) {
        const dateStr = currentYear + '-' + String(currentMonth).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        const isToday = (currentYear === today.getFullYear() && 
                        currentMonth === today.getMonth() + 1 && 
                        day === today.getDate());
        const hasEvents = eventDatesData[dateStr] > 0;
        
        let classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (hasEvents) classes += ' has-events';
        
        calendarHTML += '<div class="' + classes + '" onclick="showDayEvents(\'' + dateStr + '\')">' + day + '</div>';
      }
      
      const remainingDays = 42 - (firstDayOfWeek + lastDate);
      for (let day = 1; day <= remainingDays; day++) {
        calendarHTML += '<div class="calendar-day other-month">' + day + '</div>';
      }
      
      const gridElement = document.getElementById('calendarGrid');
      if (gridElement) {
        gridElement.innerHTML = calendarHTML;
      }
    }

    function loadMonthEvents() {
      google.script.run
        .withSuccessHandler(function(data) {
          if (data.success) {
            eventDatesData = data.eventDates;
            renderCalendar();
          }
        })
        .getMonthEvents(currentYear, currentMonth);
    }

    function changeMonth(delta) {
      currentMonth += delta;
      if (currentMonth > 12) {
        currentMonth = 1;
        currentYear++;
      } else if (currentMonth < 1) {
        currentMonth = 12;
        currentYear--;
      }
      loadMonthEvents();
    }

    function goToToday() {
      const today = new Date();
      currentYear = today.getFullYear();
      currentMonth = today.getMonth() + 1;
      loadMonthEvents();
    }

    loadMonthEvents();
    calendarRefreshInterval = setInterval(function() {
      loadMonthEvents();
    }, 60000);

    function showDayEvents(dateStr) {
      currentEventDate = dateStr;
      const modal = document.getElementById('eventModal');
      const modalBody = document.getElementById('eventModalBody');
      const addBtn = document.getElementById('addEventFromDateBtn');
      
      const date = new Date(dateStr + 'T00:00:00');
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
      const weekday = weekdays[date.getDay()];
      
      const titleElement = document.getElementById('eventModalTitle');
      if (titleElement) {
        titleElement.textContent = year + '年' + month + '月' + day + '日 (' + weekday + ') の予定';
      }
      
      if (modalBody) {
        modalBody.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>読み込み中...</p></div>';
      }
      
      if (addBtn) {
        addBtn.style.display = 'flex';
      }
      
      if (modal) {
        modal.style.display = 'block';
      }
      
      google.script.run
        .withSuccessHandler(function(data) {
          if (!data.success) {
            if (modalBody) {
              modalBody.innerHTML = '<p class="no-events">予定の取得に失敗しました</p>';
            }
            return;
          }
          
          if (data.events && data.events.length > 0) {
            let eventsHTML = '';
            
            data.events.forEach(function(event) {
              const startTime = new Date(event.startTime);
              const endTime = new Date(event.endTime);
              
              let timeStr = '';
              if (event.isAllDay) {
                timeStr = '終日';
              } else {
                timeStr = String(startTime.getHours()).padStart(2, '0') + ':' + 
                         String(startTime.getMinutes()).padStart(2, '0') + ' - ' +
                         String(endTime.getHours()).padStart(2, '0') + ':' + 
                         String(endTime.getMinutes()).padStart(2, '0');
              }
              
              let clickHandler = '';
              if (event.isTodo) {
                clickHandler = 'onclick="editTodoFromCalendar(\'' + event.taskId + '\', \'' + event.taskListId + '\', \'' + escapeHtml(event.title.replace('📋 ', '')).replace(/'/g, "\\'") + '\', \'' + (event.taskDue || '') + '\', \'' + escapeHtml(event.description || '').replace(/'/g, "\\'") + '\')"';
              } else if (event.canEdit) {
                clickHandler = 'onclick="editEvent(\'' + event.id + '\')"';
              }
              
              const itemClass = event.isTodo ? 'event-item todo-event' : 'event-item';
              
              eventsHTML += '<div class="' + itemClass + '" ' + clickHandler + '>';
              eventsHTML += '<div class="event-time">' + timeStr + '</div>';
              eventsHTML += '<div class="event-title">' + escapeHtml(event.title) + '</div>';
              if (event.location) {
                eventsHTML += '<div class="event-details">📍 ' + escapeHtml(event.location) + '</div>';
              }
              if (event.description) {
                eventsHTML += '<div class="event-details">' + escapeHtml(event.description.substring(0, 100)) + '</div>';
              }
              eventsHTML += '<div class="event-details" style="margin-top: 5px; color: #7F8C8D;">📅 ' + escapeHtml(event.calendarName) + '</div>';
              eventsHTML += '</div>';
            });
            
            if (modalBody) {
              modalBody.innerHTML = eventsHTML;
            }
          } else {
            if (modalBody) {
              modalBody.innerHTML = '<p class="no-events">この日の予定はありません</p>';
            }
          }
        })
        .withFailureHandler(function(error) {
          if (modalBody) {
            modalBody.innerHTML = '<p class="no-events">予定の取得に失敗しました</p>';
          }
        })
        .getCalendarEvents(dateStr);
    }

    function openEventModalFromDate() {
      closeModal('eventModal');
      
      editingEventId = null;
      const titleElement = document.getElementById('eventEditModalTitle');
      if (titleElement) titleElement.textContent = '予定を追加';
      
      const titleInput = document.getElementById('eventTitleInput');
      if (titleInput) titleInput.value = '';
      
      const locationInput = document.getElementById('eventLocationInput');
      if (locationInput) locationInput.value = '';
      
      const descriptionInput = document.getElementById('eventDescriptionInput');
      if (descriptionInput) descriptionInput.value = '';
      
      const allDayCheckbox = document.getElementById('eventAllDayCheckbox');
      if (allDayCheckbox) allDayCheckbox.checked = false;
      
      const dateTimeRow = document.getElementById('eventDateTimeRow');
      if (dateTimeRow) dateTimeRow.style.display = 'grid';
      
      const dateRow = document.getElementById('eventDateRow');
      if (dateRow) dateRow.style.display = 'none';
      
      const deleteBtn = document.getElementById('deleteEventBtn');
      if (deleteBtn) deleteBtn.style.display = 'none';
      
      if (currentEventDate) {
        const now = new Date();
        const roundedHour = Math.ceil(now.getHours());
        const roundedMinutes = now.getMinutes() > 30 ? '30' : '00';
        
        let startHour = roundedHour;
        let startMinutes = roundedMinutes;
        
        if (roundedMinutes === '30') {
          startMinutes = '30';
        } else if (now.getMinutes() > 0) {
          startHour = (roundedHour + 1) % 24;
          startMinutes = '00';
        }
        
        const startTime = String(startHour).padStart(2, '0') + ':' + startMinutes;
        
        let endHour = startHour;
        let endMinutes = parseInt(startMinutes) + 30;
        if (endMinutes >= 60) {
          endHour = (endHour + 1) % 24;
          endMinutes = endMinutes - 60;
        }
        
        const endTime = String(endHour).padStart(2, '0') + ':' + String(endMinutes).padStart(2, '0');
        
        const startDateTime = currentEventDate + 'T' + startTime;
        const endDateTime = currentEventDate + 'T' + endTime;
        
        const startInput = document.getElementById('eventStartInput');
        if (startInput) startInput.value = startDateTime;
        
        const endInput = document.getElementById('eventEndInput');
        if (endInput) endInput.value = endDateTime;
      }
      
      const modal = document.getElementById('eventEditModal');
      if (modal) modal.style.display = 'block';
    }

    function editTodoFromCalendar(taskId, listId, title, dueDate, notes) {
      closeModal('eventModal');
      
      editingTodoId = taskId;
      editingTodoListId = listId;
      
      const titleElement = document.getElementById('todoModalTitle');
      if (titleElement) titleElement.textContent = 'タスク編集';
      
      const titleInput = document.getElementById('todoTitleInput');
      if (titleInput) titleInput.value = title;
      
      const notesInput = document.getElementById('todoNotesInput');
      if (notesInput) notesInput.value = notes || '';
      
      if (dueDate) {
        const date = new Date(dueDate);
        const dateStr = date.getFullYear() + '-' + 
                       String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                       String(date.getDate()).padStart(2, '0');
        const dueDateInput = document.getElementById('todoDueDateInput');
        if (dueDateInput) dueDateInput.value = dateStr;
      } else {
        const dueDateInput = document.getElementById('todoDueDateInput');
        if (dueDateInput) dueDateInput.value = '';
      }
      
      const modal = document.getElementById('todoModal');
      if (modal) modal.style.display = 'block';
    }

    function openEventModal() {
      editingEventId = null;
      
      const titleElement = document.getElementById('eventEditModalTitle');
      if (titleElement) titleElement.textContent = '予定を追加';
      
      const titleInput = document.getElementById('eventTitleInput');
      if (titleInput) titleInput.value = '';
      
      const locationInput = document.getElementById('eventLocationInput');
      if (locationInput) locationInput.value = '';
      
      const descriptionInput = document.getElementById('eventDescriptionInput');
      if (descriptionInput) descriptionInput.value = '';
      
      const allDayCheckbox = document.getElementById('eventAllDayCheckbox');
      if (allDayCheckbox) allDayCheckbox.checked = false;
      
      const dateTimeRow = document.getElementById('eventDateTimeRow');
      if (dateTimeRow) dateTimeRow.style.display = 'grid';
      
      const dateRow = document.getElementById('eventDateRow');
      if (dateRow) dateRow.style.display = 'none';
      
      const deleteBtn = document.getElementById('deleteEventBtn');
      if (deleteBtn) deleteBtn.style.display = 'none';
      
      const now = new Date();
      const roundedHour = Math.ceil(now.getHours());
      const roundedMinutes = now.getMinutes() > 30 ? '30' : '00';
      
      let startHour = roundedHour;
      let startMinutes = roundedMinutes;
      
      if (roundedMinutes === '30') {
        startMinutes = '30';
      } else if (now.getMinutes() > 0) {
        startHour = (roundedHour + 1) % 24;
        startMinutes = '00';
      }
      
      const startTime = String(startHour).padStart(2, '0') + ':' + startMinutes;
      
      let endHour = startHour;
      let endMinutes = parseInt(startMinutes) + 30;
      if (endMinutes >= 60) {
        endHour = (endHour + 1) % 24;
        endMinutes = endMinutes - 60;
      }
      
      const endTime = String(endHour).padStart(2, '0') + ':' + String(endMinutes).padStart(2, '0');
      
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      
      const startDateTime = year + '-' + month + '-' + day + 'T' + startTime;
      const endDateTime = year + '-' + month + '-' + day + 'T' + endTime;
      
      const startInput = document.getElementById('eventStartInput');
      if (startInput) startInput.value = startDateTime;
      
      const endInput = document.getElementById('eventEndInput');
      if (endInput) endInput.value = endDateTime;
      
      const modal = document.getElementById('eventEditModal');
      if (modal) modal.style.display = 'block';
    }

    function toggleAllDay() {
      const isAllDay = document.getElementById('eventAllDayCheckbox');
      const dateTimeRow = document.getElementById('eventDateTimeRow');
      const dateRow = document.getElementById('eventDateRow');
      
      if (!isAllDay || !dateTimeRow || !dateRow) return;
      
      if (isAllDay.checked) {
        dateTimeRow.style.display = 'none';
        dateRow.style.display = 'grid';
        
        const startInput = document.getElementById('eventStartInput');
        const endInput = document.getElementById('eventEndInput');
        const startDateInput = document.getElementById('eventStartDateInput');
        const endDateInput = document.getElementById('eventEndDateInput');
        
        if (startInput && startInput.value && startDateInput) {
          startDateInput.value = startInput.value.split('T')[0];
        }
        if (endInput && endInput.value && endDateInput) {
          endDateInput.value = endInput.value.split('T')[0];
        }
      } else {
        dateTimeRow.style.display = 'grid';
        dateRow.style.display = 'none';
        
        const startDateInput = document.getElementById('eventStartDateInput');
        const endDateInput = document.getElementById('eventEndDateInput');
        const startInput = document.getElementById('eventStartInput');
        const endInput = document.getElementById('eventEndInput');
        
        if (startDateInput && startDateInput.value && startInput) {
          startInput.value = startDateInput.value + 'T09:00';
        }
        if (endDateInput && endDateInput.value && endInput) {
          endInput.value = endDateInput.value + 'T10:00';
        }
      }
    }

    function editEvent(eventId) {
      closeModal('eventModal');
      
      google.script.run
        .withSuccessHandler(function(data) {
          if (!data.success || !data.events || data.events.length === 0) {
            alert('予定の取得に失敗しました');
            return;
          }
          
          const event = data.events.find(e => e.id === eventId);
          if (!event || event.isTodo) {
            alert('予定が見つかりません');
            return;
          }
          
          editingEventId = eventId;
          
          const titleElement = document.getElementById('eventEditModalTitle');
          if (titleElement) titleElement.textContent = '予定を編集';
          
          const titleInput = document.getElementById('eventTitleInput');
          if (titleInput) titleInput.value = event.title;
          
          const locationInput = document.getElementById('eventLocationInput');
          if (locationInput) locationInput.value = event.location || '';
          
          const descriptionInput = document.getElementById('eventDescriptionInput');
          if (descriptionInput) descriptionInput.value = event.description || '';
          
          const startDate = new Date(event.startTime);
          const endDate = new Date(event.endTime);
          
          const allDayCheckbox = document.getElementById('eventAllDayCheckbox');
          const dateTimeRow = document.getElementById('eventDateTimeRow');
          const dateRow = document.getElementById('eventDateRow');
          
          if (event.isAllDay) {
            if (allDayCheckbox) allDayCheckbox.checked = true;
            if (dateTimeRow) dateTimeRow.style.display = 'none';
            if (dateRow) dateRow.style.display = 'grid';
            
            const startDateInput = document.getElementById('eventStartDateInput');
            if (startDateInput) startDateInput.value = formatDateOnly(startDate);
            
            const endDateInput = document.getElementById('eventEndDateInput');
            if (endDateInput) endDateInput.value = formatDateOnly(endDate);
          } else {
            if (allDayCheckbox) allDayCheckbox.checked = false;
            if (dateTimeRow) dateTimeRow.style.display = 'grid';
            if (dateRow) dateRow.style.display = 'none';
            
            const startInput = document.getElementById('eventStartInput');
            if (startInput) startInput.value = formatDateTimeLocal(startDate);
            
            const endInput = document.getElementById('eventEndInput');
            if (endInput) endInput.value = formatDateTimeLocal(endDate);
          }
          
          const deleteBtn = document.getElementById('deleteEventBtn');
          if (deleteBtn) deleteBtn.style.display = 'flex';
          
          const modal = document.getElementById('eventEditModal');
          if (modal) modal.style.display = 'block';
        })
        .getCalendarEvents(currentEventDate);
    }

    function saveEvent() {
      const titleInput = document.getElementById('eventTitleInput');
      const locationInput = document.getElementById('eventLocationInput');
      const descriptionInput = document.getElementById('eventDescriptionInput');
      const allDayCheckbox = document.getElementById('eventAllDayCheckbox');
      
      const title = titleInput ? titleInput.value.trim() : '';
      const location = locationInput ? locationInput.value.trim() : '';
      const description = descriptionInput ? descriptionInput.value.trim() : '';
      const isAllDay = allDayCheckbox ? allDayCheckbox.checked : false;
      
      let startTime, endTime;
      
      if (isAllDay) {
        const startDateInput = document.getElementById('eventStartDateInput');
        const endDateInput = document.getElementById('eventEndDateInput');
        
        const startDate = startDateInput ? startDateInput.value : '';
        const endDate = endDateInput ? endDateInput.value : '';
        
        if (!title || !startDate || !endDate) {
          alert('タイトル、開始日、終了日は必須です');
          return;
        }
        
        startTime = startDate + 'T00:00:00';
        const endDateObj = new Date(endDate);
        endDateObj.setDate(endDateObj.getDate() + 1);
        endTime = formatDateOnly(endDateObj) + 'T00:00:00';
      } else {
        const startInput = document.getElementById('eventStartInput');
        const endInput = document.getElementById('eventEndInput');
        
        startTime = startInput ? startInput.value : '';
        endTime = endInput ? endInput.value : '';
        
        if (!title || !startTime || !endTime) {
          alert('タイトル、開始日時、終了日時は必須です');
          return;
        }
      }
      
      closeModal('eventEditModal');
      
      if (editingEventId) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              loadMonthEvents();
              updateSummaryDashboard();
              if (currentEventDate) {
                showDayEvents(currentEventDate);
              }
            } else {
              alert('予定の更新に失敗しました');
            }
          })
          .withFailureHandler(function(error) {
            alert('予定の更新に失敗しました');
          })
          .updateCalendarEvent(editingEventId, title, startTime, endTime, description, location);
      } else {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              loadMonthEvents();
              updateSummaryDashboard();
            } else {
              alert('予定の追加に失敗しました');
            }
          })
          .withFailureHandler(function(error) {
            alert('予定の追加に失敗しました');
          })
          .addCalendarEvent(title, startTime, endTime, description, location);
      }
    }

    function deleteEvent() {
      if (!confirm('この予定を削除しますか?')) return;
      
      closeModal('eventEditModal');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            loadMonthEvents();
            updateSummaryDashboard();
            if (currentEventDate) {
              showDayEvents(currentEventDate);
            }
          } else {
            alert('予定の削除に失敗しました');
          }
        })
        .withFailureHandler(function(error) {
          alert('予定の削除に失敗しました');
        })
        .deleteCalendarEvent(editingEventId);
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'none';
      }
      
      if (modalId === 'eventModal') {
        const addBtn = document.getElementById('addEventFromDateBtn');
        if (addBtn) {
          addBtn.style.display = 'none';
        }
      }
    }

    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
        
        if (event.target.id === 'eventModal') {
          const addBtn = document.getElementById('addEventFromDateBtn');
          if (addBtn) {
            addBtn.style.display = 'none';
          }
        }
      }
    };

    function formatEmailDate(date) {
      const now = new Date();
      const diff = now - date;
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (hours < 24) {
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const hour = String(date.getHours()).padStart(2, '0');
        const minute = String(date.getMinutes()).padStart(2, '0');
        return month + '/' + day + ' ' + hour + ':' + minute;
      }

      if (days < 7) {
        return days + '日前';
      }

      const month = date.getMonth() + 1;
      const day = date.getDate();
      return month + '/' + day;
    }

    function formatRelativeTime(date) {
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);

      if (minutes < 1) {
        return 'たった今';
      }

      if (minutes < 60) {
        return minutes + '分前';
      }

      const hours = Math.floor(minutes / 60);
      if (hours < 24) {
        return hours + '時間前';
      }

      const days = Math.floor(hours / 24);
      if (days < 7) {
        return days + '日前';
      }

      const month = date.getMonth() + 1;
      const day = date.getDate();
      return month + '/' + day;
    }

    function formatTodoDate(date) {
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      return year + '/' + month + '/' + day;
    }

    function formatDateTimeLocal(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return year + '-' + month + '-' + day + 'T' + hours + ':' + minutes;
    }

    function formatDateOnly(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }

    function escapeHtml(text) {
      if (!text) return '';
      return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function truncateText(text, maxLength) {
      if (!text) return '';
      if (text.length <= maxLength) {
        return text;
      }
      return text.substring(0, maxLength) + '…';
    }

    window.addEventListener('beforeunload', function() {
      if (emailRefreshInterval) clearInterval(emailRefreshInterval);
      if (chatRefreshInterval) clearInterval(chatRefreshInterval);
      if (calendarRefreshInterval) clearInterval(calendarRefreshInterval);
      if (summaryRefreshInterval) clearInterval(summaryRefreshInterval);
    });
  </script>
</body>
</html>
